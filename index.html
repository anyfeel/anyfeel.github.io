<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.2',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="我就是我，是颜色不一样的烟花">
<meta property="og:type" content="website">
<meta property="og:title" content="冰澜">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="冰澜">
<meta property="og:description" content="我就是我，是颜色不一样的烟花">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="冰澜">
<meta name="twitter:description" content="我就是我，是颜色不一样的烟花">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>冰澜</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冰澜</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/29/link-load-library/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/29/link-load-library/" itemprop="url">
                  link-load-library
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-29 23:09:52 / 修改时间：23:21:40" itemprop="dateCreated datePublished" datetime="2019-11-29T23:09:52+08:00">2019-11-29</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/29/link-load-library/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/29/link-load-library/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/11/29/link-load-library/" class="leancloud_visitors" data-flag-title="link-load-library">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><h2 id="过度优化-volatile"><a href="#过度优化-volatile" class="headerlink" title="过度优化 - volatile"></a>过度优化 - volatile</h2><ul>
<li><p>编译器优化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x= <span class="number">0</span></span><br><span class="line">Thread1            Thread2</span><br><span class="line">lock();            lock;</span><br><span class="line">x++;               x++;</span><br><span class="line">unlock();          unlock();</span><br></pre></td></tr></table></figure>
<p>变量缓存在寄存器而不写回</p>
</li>
<li><p>cpu 动态调度换序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = y = <span class="number">0</span>;</span><br><span class="line">Thread1           Thread2</span><br><span class="line">x= <span class="number">1</span>;             y = <span class="number">1</span>;</span><br><span class="line">r1 = y;           r2 = x;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = y = <span class="number">0</span>;</span><br><span class="line">Thread1           Thread2</span><br><span class="line">r1 = y;           y = <span class="number">1</span>;</span><br><span class="line">x1 = <span class="number">1</span>;           r2 = x;</span><br></pre></td></tr></table></figure>
<p>编译器指令顺序交换</p>
</li>
</ul>
<hr>
<h2 id="过度优化-barrier"><a href="#过度优化-barrier" class="headerlink" title="过度优化 - barrier"></a>过度优化 - barrier</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> T* pInst = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">T* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pInst == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        lock();</span><br><span class="line">        <span class="keyword">if</span> (pInst == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pInst == <span class="keyword">new</span> T;</span><br><span class="line">        &#125;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pInst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++ 的 new 对象是分 2 个步骤:</p>
<ul>
<li>分配内存</li>
<li>调用构造函数</li>
</ul>
<p>pInst = new T 包含了 3 个步骤:</p>
<ul>
<li>分配内存</li>
<li>在分配内存上调用构造函数</li>
<li>将内存地址复制给 pInst</li>
</ul>
<p>而步骤 2 和步骤 3 是可以交换的，导致的问题是分配的内存尚未调用构造函数就已经被分配出去</p>
<hr>
<p>使用 <code>lwsync</code> 指令，防止编译指令换序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> barrier() __asm__ volatile (<span class="meta-string">"lwsync"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> T* pInst = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">T* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pInst != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        lock();</span><br><span class="line">        <span class="keyword">if</span> (pInst != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            T* temp = <span class="keyword">new</span> T;</span><br><span class="line">            barrier();</span><br><span class="line">            pInst == temp;</span><br><span class="line">        &#125;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pInst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="内存与装载"><a href="#内存与装载" class="headerlink" title="内存与装载"></a>内存与装载</h1><p>64 位内核虚拟地址和程序布局空间关系</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/memory.png" alt=":scale 100%"></p>
<hr>
<p>可执行文件，虚拟地址空间和物理地址空间的映射关系</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/memory-maping1.png" alt=":scale 100%"></p>
<hr>
<h2 id="进程堆管理"><a href="#进程堆管理" class="headerlink" title="进程堆管理"></a>进程堆管理</h2><p>两种堆分配形式</p>
<ul>
<li>brk 系统调用，设置进程数据段的结束地址，向高地址移动，扩大的部分空间可以被程序使用（sbrk 对 brk 的包装）</li>
<li>mmap 向操作系统申请一段虚拟地址空间，可以映射到某个文件，不映射文件时为匿名空间（用于 malloc)</li>
</ul>
<h2 id="调用惯例"><a href="#调用惯例" class="headerlink" title="调用惯例"></a>调用惯例</h2><p>函数调用方和被调用的约定</p>
<ul>
<li>函数参数的传递顺序和方式（栈传递，寄存器传递；压栈顺序（左到右，右到左））</li>
<li>栈的维护方式，出栈由调用方还是被调用方</li>
<li>名字修饰策略</li>
</ul>
<table>
<thead>
<tr>
<th>调用惯例</th>
<th>出栈方</th>
<th>参数传递</th>
<th>名字修饰</th>
</tr>
</thead>
<tbody>
<tr>
<td>cdecl</td>
<td>函数调用方</td>
<td>从右至左</td>
<td>下划线+函数名</td>
</tr>
<tr>
<td>stdcall</td>
<td>函数本身</td>
<td>从右至左压栈</td>
<td>下划线+函数名+@+参数字节数，如 int func(int a, double b) -&gt; _func@12</td>
</tr>
<tr>
<td>fastcall</td>
<td>函数本身</td>
<td>头两个字节放入寄存器，其他从右至左压栈</td>
<td>@+函数名+@+参数字节数</td>
</tr>
<tr>
<td>pascal</td>
<td>函数本身</td>
<td>从左至右压入栈</td>
<td>较复杂</td>
</tr>
</tbody>
</table>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><ul>
<li>预编译</li>
<li>编译</li>
<li>汇编</li>
<li>链接</li>
</ul>
<h2 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h2><p>预编译工作:宏展开，删除注释，生成行号和文件标识</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hellow world!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~ gcc -E hello.c -o hello.i</span><br><span class="line">~ cat hello.i</span><br><span class="line">...</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span># <span class="number">840</span> <span class="string">"/usr/include/stdio.h"</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">extern void flockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__));</span><br><span class="line">extern int ftrylockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__)) ;</span><br><span class="line">extern void funlockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__));</span><br><span class="line"># <span class="number">868</span> <span class="string">"/usr/include/stdio.h"</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">2</span> <span class="string">"hello.c"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">3</span> <span class="string">"hello.c"</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hellow world!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h2><ul>
<li>词法分析</li>
<li>语法分析</li>
<li>语义分析</li>
</ul>
<h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array[index] = (index + 4) * (2 + 6)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>symbol</strong></td>
<td style="text-align:center">array</td>
<td style="text-align:center">[</td>
<td style="text-align:center">index</td>
<td style="text-align:center">]</td>
<td style="text-align:center">=</td>
<td style="text-align:center">（</td>
<td style="text-align:center">index</td>
<td style="text-align:center">+</td>
<td style="text-align:center">4</td>
<td style="text-align:center">）</td>
<td style="text-align:center">*</td>
<td style="text-align:center">（</td>
<td style="text-align:center">2</td>
<td style="text-align:center">+</td>
<td style="text-align:center">6</td>
<td style="text-align:center">）</td>
</tr>
<tr>
<td style="text-align:center"><strong>type</strong></td>
<td style="text-align:center">标识符</td>
<td style="text-align:center">左方括号</td>
<td style="text-align:center">标识符</td>
<td style="text-align:center">右方括号</td>
<td style="text-align:center">赋值</td>
<td style="text-align:center">左圆括号</td>
<td style="text-align:center">标识符</td>
<td style="text-align:center">加号</td>
<td style="text-align:center">数字</td>
<td style="text-align:center">右圆括号</td>
<td style="text-align:center">乘号</td>
<td style="text-align:center">左圆括号</td>
<td style="text-align:center">数字</td>
<td style="text-align:center">加号</td>
<td style="text-align:center">数字</td>
<td style="text-align:center">右圆括号</td>
</tr>
</tbody>
</table>
<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p><img src="http://onepiece.nos-eastchina1.126.net/markdown/语法树.png" alt=":scale 100%"></p>
<hr>
<h3 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h3><p><img src="http://onepiece.nos-eastchina1.126.net/markdown/语义分析.png" alt=":scale 100%"></p>
<hr>
<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><p>汇编代码转换成机器指令(可理解为 2 进制)</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p>目标文件链接成可执行文件</p>
<ul>
<li>地址和空间分配 - Address and Storage Allocation</li>
<li>符号决议 - Symbol Resolution</li>
<li>重定位 - Relocation</li>
</ul>
<hr>
<h1 id="目标文件"><a href="#目标文件" class="headerlink" title="目标文件"></a>目标文件</h1><h2 id="目标文件类型"><a href="#目标文件类型" class="headerlink" title="目标文件类型"></a>目标文件类型</h2><table>
<thead>
<tr>
<th style="text-align:left">目标文件类型</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Relocatable File</td>
<td style="text-align:left">包含代码和数据，可链接为可执行文件或者共享目标文件，静态文件也属于这一类</td>
<td style="text-align:left">*.o</td>
</tr>
<tr>
<td style="text-align:left">Executable File</td>
<td style="text-align:left">可执行文件</td>
<td style="text-align:left">/bin/bash</td>
</tr>
<tr>
<td style="text-align:left">Shared Object File</td>
<td style="text-align:left">可以和其他重新可定位文件链接成新的共享文件；作为运行进程的映象一部分</td>
<td style="text-align:left">*.so</td>
</tr>
<tr>
<td style="text-align:left">Core Dump File</td>
<td style="text-align:left">进程意外终止是的堆栈信息</td>
<td style="text-align:left">core dump</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="目标内容"><a href="#目标内容" class="headerlink" title="目标内容"></a>目标内容</h2><p>示例代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int printf(const char* format, ...);</span><br><span class="line"></span><br><span class="line">int global_init_var = 84;</span><br><span class="line">int global_uniit_var;</span><br><span class="line"></span><br><span class="line">void func1(int i) &#123;</span><br><span class="line">    printf(&quot;%d\n&quot;, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line">    static int static_var = 85;</span><br><span class="line">    static int static_var2;</span><br><span class="line"></span><br><span class="line">    int a = 1;</span><br><span class="line">    int b;</span><br><span class="line">    func1(static_var + static_var2 + a + b);</span><br><span class="line"></span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看示例代码的 <code>Sections</code> 情况，因为还是目标文件，<code>VMA</code> 和 <code>LMA</code> 地址都是 0，需要在链接的时候确定，objdump 目标文件的一些常见 <code>Section</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -w -h SimpleSection.o</span><br><span class="line"></span><br><span class="line">SimpleSection.o:     file format elf64-x86-<span class="number">64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name            Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  <span class="number">0</span> .text           <span class="number">00000057</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">00000040</span>  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  <span class="number">1</span> .data           <span class="number">00000008</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">00000098</span>  <span class="number">2</span>**<span class="number">2</span>  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  <span class="number">2</span> .bss            <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a0  <span class="number">2</span>**<span class="number">2</span>  ALLOC</span><br><span class="line">  <span class="number">3</span> .rodata         <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a0  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  <span class="number">4</span> .comment        <span class="number">00000012</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a4  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, READONLY</span><br><span class="line">  <span class="number">5</span> .note.GNU-stack <span class="number">00000000</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>b6  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, READONLY</span><br><span class="line">  <span class="number">6</span> .eh_frame       <span class="number">00000058</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>b8  <span class="number">2</span>**<span class="number">3</span>  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br></pre></td></tr></table></figure>
<p><em>Sections</em> 常见字段含义</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">.text</td>
<td style="text-align:left">代码段</td>
</tr>
<tr>
<td style="text-align:left">.data</td>
<td style="text-align:left">数据段</td>
</tr>
<tr>
<td style="text-align:left">.bss</td>
<td style="text-align:left">未初始化的全局变量和静态变量</td>
</tr>
<tr>
<td style="text-align:left">.rodata</td>
<td style="text-align:left">只读数据段（只读字符串等， eg:  “hello %s”)</td>
</tr>
<tr>
<td style="text-align:left">.comment</td>
<td style="text-align:left">编译器版本信息</td>
</tr>
<tr>
<td style="text-align:left">.note.GNU-stack</td>
<td style="text-align:left">堆栈提示段</td>
</tr>
<tr>
<td style="text-align:left">.eh_frame</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="目标文件段分布"><a href="#目标文件段分布" class="headerlink" title="目标文件段分布"></a>目标文件段分布</h2><p>使用 <code>readelf</code> 查看目标文件中的所有 <code>Section</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vagrant@onepiece:~/tmp   readelf -S SimpleSection.o</span><br><span class="line">There are <span class="number">13</span> section headers, starting at offset <span class="number">0x438</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type     Address           Offset   Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>     <span class="number">0000000000000000</span>  <span class="number">00000000</span> <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS <span class="number">0000000000000000</span>  <span class="number">00000040</span> <span class="number">0000000000000057</span>  <span class="number">0000000000000000</span>  AX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">3</span>] .data             PROGBITS <span class="number">0000000000000000</span>  <span class="number">00000098</span> <span class="number">0000000000000008</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .rodata           PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000</span>a0 <span class="number">0000000000000004</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .bss              NOBITS   <span class="number">0000000000000000</span>  <span class="number">000000</span>a0 <span class="number">0000000000000004</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">4</span></span><br><span class="line">  [ <span class="number">6</span>] .comment          PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000</span>a4 <span class="number">0000000000000012</span>  <span class="number">0000000000000001</span>  MS       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">7</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000b</span>6 <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">8</span>] .eh_frame         PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000b</span>8 <span class="number">0000000000000058</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">8</span></span><br><span class="line">  [<span class="number">10</span>] .symtab           SYMTAB   <span class="number">0000000000000000</span>  <span class="number">00000110</span> <span class="number">0000000000000198</span>  <span class="number">0000000000000018</span>          <span class="number">11</span>    <span class="number">11</span>     <span class="number">8</span></span><br><span class="line">  [<span class="number">11</span>] .strtab           STRTAB   <span class="number">0000000000000000</span>  <span class="number">000002</span>a8 <span class="number">000000000000007b</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .rela.text        RELA     <span class="number">0000000000000000</span>  <span class="number">00000328</span> <span class="number">0000000000000078</span>  <span class="number">0000000000000018</span>   I      <span class="number">10</span>     <span class="number">1</span>     <span class="number">8</span></span><br><span class="line">  [ <span class="number">9</span>] .rela.eh_frame    RELA     <span class="number">0000000000000000</span>  <span class="number">000003</span>a0 <span class="number">0000000000000030</span>  <span class="number">0000000000000018</span>   I      <span class="number">10</span>     <span class="number">8</span>     <span class="number">8</span></span><br><span class="line">  [<span class="number">12</span>] .shstrtab         STRTAB   <span class="number">0000000000000000</span>  <span class="number">000003</span>d0 <span class="number">0000000000000061</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h1><h2 id="静态链接过程"><a href="#静态链接过程" class="headerlink" title="静态链接过程"></a>静态链接过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ gcc -c a.c</span><br><span class="line">~ gcc -c b.c</span><br><span class="line">~ ld a.o b.o -e main -o ab</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/* a.c */</span><br><span class="line">extern int shared;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int a = 100;</span><br><span class="line">    swap(&amp;a, &amp;shared);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* b.c  */</span><br><span class="line">int shared = 1;</span><br><span class="line">void swap(int* a, int *b) &#123;</span><br><span class="line">    *a ^= *b ^= *a ^= *b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h3><p>合并多个目标文件中的相同 <code>Section</code>, 分配内存和虚拟地址<br><img src="http://onepiece.nos-eastchina1.126.net/markdown/section-merge.png" alt=":scale 80%"></p>
<h3 id="符号地址确定"><a href="#符号地址确定" class="headerlink" title="符号地址确定"></a>符号地址确定</h3><p>单个目标文件中，每个 <code>Section</code> 的位置已确定，每条指令的 <code>offset</code> 也是固定的，在合并多个目标文件后，<br>将多个相同 <code>Section</code> 合并，调整对应 <code>Section</code> 中的 <code>offset</code> 得到 <code>Section</code> 合并后的 <code>offset</code></p>
<p>另外所有的 <code>VMA</code> 地址未初始化，<code>VMA</code> 的值为 64 linux kernel 的用户态虚拟空间的起始地址 <code>0000000000400000</code><br>加上入口函数（这里先看做是 main 函数）的偏移量（按页对齐）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -w -h a.o</span><br><span class="line">Idx Name            Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  0 .text           0000002e  0000000000000000  0000000000000000  00000040  2**0  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  1 .data           00000000  0000000000000000  0000000000000000  0000006e  2**0  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss            00000000  0000000000000000  0000000000000000  0000006e  2**0  ALLOC</span><br><span class="line">  3 .comment        00000012  0000000000000000  0000000000000000  0000006e  2**0  CONTENTS, READONLY</span><br><span class="line">  4 .note.GNU-stack 00000000  0000000000000000  0000000000000000  00000080  2**0  CONTENTS, READONLY</span><br><span class="line">  5 .eh_frame       00000038  0000000000000000  0000000000000000  00000080  2**3  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">~ objdump -w -h b.o</span><br><span class="line">Idx Name            Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  0 .text           0000004b  0000000000000000  0000000000000000  00000040  2**0  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  1 .data           00000004  0000000000000000  0000000000000000  0000008c  2**2  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss            00000000  0000000000000000  0000000000000000  00000090  2**0  ALLOC</span><br><span class="line">  3 .comment        00000012  0000000000000000  0000000000000000  00000090  2**0  CONTENTS, READONLY</span><br><span class="line">  4 .note.GNU-stack 00000000  0000000000000000  0000000000000000  000000a2  2**0  CONTENTS, READONLY</span><br><span class="line">  5 .eh_frame       00000038  0000000000000000  0000000000000000  000000a8  2**3  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">~ objdump -w -h ab</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  0 .text         00000079  0000000000401000  0000000000401000  00001000  2**0  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  1 .eh_frame     00000058  0000000000402000  0000000000402000  00002000  2**3  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  2 .data         00000004  0000000000404000  0000000000404000  00003000  2**2  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  3 .comment      00000011  0000000000000000  0000000000000000  00003004  2**0  CONTENTS, READONLY</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<h3 id="重定位（指令修正）"><a href="#重定位（指令修正）" class="headerlink" title="重定位（指令修正）"></a>重定位（指令修正）</h3><p>可执行文件中需要重定位的符号的指令地址尚未初始化，先查看需要充定位的符号(UND 类型)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -s a.o</span><br><span class="line"></span><br><span class="line">Symbol table &apos;.symtab&apos; contains 12 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS a.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7</span><br><span class="line">     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     8: 0000000000000000    46 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">     9: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND shared                  // UND 表示未定义的符号，需要重定位</span><br><span class="line">    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND swap                    // 同上</span><br></pre></td></tr></table></figure></p>
<p>查看需要重定位的符号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -r a.o</span><br><span class="line">Relocation section &apos;.rela.text&apos; at offset 0x208 contains 2 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000016  000900000002 R_X86_64_PC32     0000000000000000 shared - 4           // R_X86_64_PC32  相对地址修正</span><br><span class="line">000000000023  000b00000004 R_X86_64_PLT32    0000000000000000 swap - 4             // R_X86_64_PLT32 相对地址修正 + 延迟绑定</span><br><span class="line"></span><br><span class="line">Relocation section &apos;.rela.eh_frame&apos; at offset 0x238 contains 1 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span><br></pre></td></tr></table></figure>
<p>查看 a.o 的汇编代码，看看未重定位前的指令地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -d a.o</span><br><span class="line">0000000000000000 &lt;main&gt;:</span><br><span class="line">   0:   55                      push   %rbp</span><br><span class="line">   1:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">   4:   48 83 ec 10             sub    $0x10,%rsp</span><br><span class="line">   8:   c7 45 fc 64 00 00 00    movl   $0x64,-0x4(%rbp)</span><br><span class="line">   f:   48 8d 45 fc             lea    -0x4(%rbp),%rax</span><br><span class="line">  13:   48 8d 35 00 00 00 00    lea    0x0(%rip),%rsi              # 1a &lt;main+0x1a&gt;  // shared 变量引用， (00 00 00 00) 0x0 未赋值,</span><br><span class="line">  1a:   48 89 c7                mov    %rax,%rdi                                     // 0x1a 是下一条指令偏移，lea 指令压入下一条指令地址</span><br><span class="line">  1d:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  22:   e8 00 00 00 00          callq  27 &lt;main+0x27&gt;                                // callq 调用 swap 函数，0x27 是下一条指令地址</span><br><span class="line">  27:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  2c:   c9                      leaveq</span><br><span class="line">  2d:   c3                      retq</span><br></pre></td></tr></table></figure></p>
<p>查看链接完成后的指令地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -d ab</span><br><span class="line">0000000000401000 &lt;main&gt;:</span><br><span class="line">  401000:       55                      push   %rbp</span><br><span class="line">  401001:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  401004:       48 83 ec 10             sub    $0x10,%rsp</span><br><span class="line">  401008:       c7 45 fc 64 00 00 00    movl   $0x64,-0x4(%rbp)</span><br><span class="line">  40100f:       48 8d 45 fc             lea    -0x4(%rbp),%rax</span><br><span class="line">  401013:       48 8d 35 e6 2f 00 00    lea    0x2fe6(%rip),%rsi  # 404000 &lt;shared&gt;  // 0x2fe6 = 0x404000 - 0x40101a</span><br><span class="line">  40101a:       48 89 c7                mov    %rax,%rdi</span><br><span class="line">  40101d:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  401022:       e8 07 00 00 00          callq  40102e &lt;swap&gt;                         // e8 00 00 00 00 -&gt; e8 07 00 00 00;  0x7= 0x40102e - 0x401027</span><br><span class="line">  401027:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  40102c:       c9                      leaveq</span><br><span class="line">  40102d:       c3                      retq</span><br><span class="line"></span><br><span class="line">000000000040102e &lt;swap&gt;:</span><br><span class="line">  40102e:       55                      push   %rbp</span><br><span class="line">  40102f:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  401032:       48 89 7d f8             mov    %rdi,-0x8(%rbp)</span><br><span class="line">  401036:       48 89 75 f0             mov    %rsi,-0x10(%rbp)</span><br></pre></td></tr></table></figure></p>
<h2 id="common块之强弱符号"><a href="#common块之强弱符号" class="headerlink" title="common块之强弱符号"></a>common块之强弱符号</h2><p>强符号:函数和已初始化的全局变量为；弱符号:未初始化的全局变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">extern int ext;</span><br><span class="line"></span><br><span class="line">int weak;                            //  弱符号</span><br><span class="line">int string = 1;                      //  强符号</span><br><span class="line">__attribute__((weak)) weak2 = 2;     //  弱符号</span><br><span class="line"></span><br><span class="line">int main() &#123;                         //  强符号</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多个文件中出现对同一个文件的定义，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/* a. c */  |   /* b.c */</span><br><span class="line">int a;      |   long a;</span><br></pre></td></tr></table></figure>
<ul>
<li>多个强符号冲突，编译失败</li>
<li>强符号和弱符号同时定义，选强符号</li>
<li>多个弱符号，选类型最大的弱符号</li>
<li>定义弱引用，编译时不会报错，运行时报错，可用于链接库函数（比如程序是否支持多线程版本 ‘-lphread’)</li>
<li>使用 ‘-fno-common’ 禁用弱引用</li>
</ul>
<h2 id="全局构造和析构"><a href="#全局构造和析构" class="headerlink" title="全局构造和析构"></a>全局构造和析构</h2><p>main 函数只是编写代码的入口，实际程序运行的入口是 <code>_start</code>，c++ 使用特殊的 <code>Section</code> 控制全局构造和析构</p>
<ul>
<li>.init 构成进程的初始化代码，在 main 函数之前调用</li>
<li>.fini 构成进程的终止代码，在 main 函数退出后执行</li>
</ul>
<h2 id="静态库链接"><a href="#静态库链接" class="headerlink" title="静态库链接"></a>静态库链接</h2><p>静态库是一组目标文件的集合，基本上其中的一个目标文件只包含一个函数，链接时从库中找到具体的函数实现链接成可执行文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ ar -t /usr/lib/libc.a | grep printf</span><br><span class="line">vfprintf.o</span><br><span class="line">vprintf.o</span><br><span class="line">printf_fp.o</span><br><span class="line">reg-printf.o</span><br><span class="line">printf-prs.o</span><br><span class="line">printf_fphex.o</span><br><span class="line">printf_size.o</span><br><span class="line">fprintf.o</span><br></pre></td></tr></table></figure>
<p>如何不使用 <code># include &lt;stdio.h&gt;</code> 实现 hello.c 中对标准库中 <code>printf</code> 函数的引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* hello.c */</span><br><span class="line">int main() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ ar -x /usr/lib/libc.a  -&gt; 得到 printf.o 目标文件</span><br><span class="line">~ ld hello.o printf.o    -&gt; 实际上也会失败，因为 printf 还依赖其他目标文件(vfpintf.o)，但可以按照层次去解决</span><br></pre></td></tr></table></figure>
<p>链接成可执行文件需要的库和目标文件</p>
<ul>
<li>crt1.o</li>
<li>crti.o</li>
<li>crtbeginT.o</li>
<li>libgcc.a</li>
<li>libgcc_eh.a</li>
<li>libc.a</li>
<li>crtend.o</li>
<li>crtn.o</li>
</ul>
<p>crt1.o、crti.o 和 crtn.o 均是 glibc 运行库启动文件的一部分，运行库部分讲解！！</p>
<h2 id="静态链接示例"><a href="#静态链接示例" class="headerlink" title="静态链接示例"></a>静态链接示例</h2><p>静态链接的一个例子，代码和分布</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">        sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -W -S SectionMapping.elf | column</span><br><span class="line">There are <span class="number">31</span> section headers, starting at offset <span class="number">0xbc330</span>:</span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name                Type        Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                     <span class="literal">NULL</span>        <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .note.gnu.build-id  NOTE        <span class="number">0000000000400200</span> <span class="number">000200</span> <span class="number">000024</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .note.ABI-tag       NOTE        <span class="number">0000000000400224</span> <span class="number">000224</span> <span class="number">000020</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .rela.plt           RELA        <span class="number">0000000000400248</span> <span class="number">000248</span> <span class="number">000240</span> <span class="number">18</span>  AI  <span class="number">0</span>  <span class="number">19</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">4</span>] .init               PROGBITS    <span class="number">0000000000401000</span> <span class="number">001000</span> <span class="number">00001b</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .plt                PROGBITS    <span class="number">0000000000401020</span> <span class="number">001020</span> <span class="number">0000</span>c0 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">6</span>] .text               PROGBITS    <span class="number">00000000004010e0</span> <span class="number">0010e0</span> <span class="number">07e1</span>c0 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">7</span>] __libc_freeres_fn   PROGBITS    <span class="number">000000000047f</span>2a0 <span class="number">07f</span>2a0 <span class="number">000</span>aa0 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">8</span>] .fini               PROGBITS    <span class="number">000000000047f</span>d40 <span class="number">07f</span>d40 <span class="number">00000</span>d <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">9</span>] .rodata             PROGBITS    <span class="number">0000000000480000</span> <span class="number">080000</span> <span class="number">01</span>aa8c <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">10</span>] .stapsdt.base       PROGBITS    <span class="number">000000000049</span>aa8c <span class="number">09</span>aa8c <span class="number">000001</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">11</span>] .eh_frame           PROGBITS    <span class="number">000000000049</span>aa90 <span class="number">09</span>aa90 <span class="number">00</span>a1ac <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">12</span>] .gcc_except_table   PROGBITS    <span class="number">00000000004</span>a4c3c <span class="number">0</span>a4c3c <span class="number">0000b</span>1 <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">13</span>] .tdata              PROGBITS    <span class="number">00000000004</span>a6140 <span class="number">0</span>a5140 <span class="number">000020</span> <span class="number">00</span> WAT  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">14</span>] .tbss               NOBITS      <span class="number">00000000004</span>a6160 <span class="number">0</span>a5160 <span class="number">000040</span> <span class="number">00</span> WAT  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">15</span>] .init_array         INIT_ARRAY  <span class="number">00000000004</span>a6160 <span class="number">0</span>a5160 <span class="number">000010</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">16</span>] .fini_array         FINI_ARRAY  <span class="number">00000000004</span>a6170 <span class="number">0</span>a5170 <span class="number">000010</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">17</span>] .data.rel.ro        PROGBITS    <span class="number">00000000004</span>a6180 <span class="number">0</span>a5180 <span class="number">002</span>d74 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">18</span>] .got                PROGBITS    <span class="number">00000000004</span>a8ef8 <span class="number">0</span>a7ef8 <span class="number">0000f</span>0 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">19</span>] .got.plt            PROGBITS    <span class="number">00000000004</span>a9000 <span class="number">0</span>a8000 <span class="number">0000</span>d8 <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">20</span>] .data               PROGBITS    <span class="number">00000000004</span>a90e0 <span class="number">0</span>a80e0 <span class="number">001</span>a50 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">21</span>] __libc_subfreeres   PROGBITS    <span class="number">00000000004</span>aab30 <span class="number">0</span>a9b30 <span class="number">000048</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">22</span>] __libc_IO_vtables   PROGBITS    <span class="number">00000000004</span>aab80 <span class="number">0</span>a9b80 <span class="number">0006</span>a8 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">23</span>] __libc_atexit       PROGBITS    <span class="number">00000000004</span>ab228 <span class="number">0</span>aa228 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">24</span>] .bss                NOBITS      <span class="number">00000000004</span>ab240 <span class="number">0</span>aa230 <span class="number">001758</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">25</span>] __libc_freeres_ptrs NOBITS      <span class="number">00000000004</span>ac998 <span class="number">0</span>aa230 <span class="number">000028</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">26</span>] .comment            PROGBITS    <span class="number">0000000000000000</span> <span class="number">0</span>aa230 <span class="number">000011</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">27</span>] .note.stapsdt       NOTE        <span class="number">0000000000000000</span> <span class="number">0</span>aa244 <span class="number">000048</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">28</span>] .symtab             SYMTAB      <span class="number">0000000000000000</span> <span class="number">0</span>aa290 <span class="number">00b</span>0a0 <span class="number">18</span>     <span class="number">29</span> <span class="number">752</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">29</span>] .strtab             STRTAB      <span class="number">0000000000000000</span> <span class="number">0b</span>5330 <span class="number">006</span>eb5 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">30</span>] .shstrtab           STRTAB      <span class="number">0000000000000000</span> <span class="number">0b</span>c1e5 <span class="number">000144</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<h2 id="静态链接内存映射"><a href="#静态链接内存映射" class="headerlink" title="静态链接内存映射"></a>静态链接内存映射</h2><p>查看编译好的 elf 文件的 <code>Segment</code>(将 Section 合并得到 <code>Segment</code>) 信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -W -l SectionMapping.elf</span><br><span class="line"></span><br><span class="line">Elf file <span class="keyword">type</span> is EXEC (Executable file)</span><br><span class="line">Entry point <span class="number">0x401ac0</span></span><br><span class="line">There are <span class="number">8</span> program headers, starting at offset <span class="number">64</span></span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  LOAD           <span class="number">0x000000</span> <span class="number">0x0000000000400000</span> <span class="number">0x0000000000400000</span> <span class="number">0x000488</span> <span class="number">0x000488</span> R   <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x001000</span> <span class="number">0x0000000000401000</span> <span class="number">0x0000000000401000</span> <span class="number">0x07ed4d</span> <span class="number">0x07ed4d</span> R E <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x080000</span> <span class="number">0x0000000000480000</span> <span class="number">0x0000000000480000</span> <span class="number">0x024ced</span> <span class="number">0x024ced</span> R   <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x0a5140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x0050f</span>0 <span class="number">0x006880</span> RW  <span class="number">0x1000</span></span><br><span class="line">  NOTE           <span class="number">0x000200</span> <span class="number">0x0000000000400200</span> <span class="number">0x0000000000400200</span> <span class="number">0x000044</span> <span class="number">0x000044</span> R   <span class="number">0x4</span></span><br><span class="line">  TLS            <span class="number">0x0a5140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x000020</span> <span class="number">0x000060</span> R   <span class="number">0x8</span></span><br><span class="line">  GNU_STACK      <span class="number">0x000000</span> <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span> <span class="number">0x000000</span> <span class="number">0x000000</span> RW  <span class="number">0x10</span></span><br><span class="line">  GNU_RELRO      <span class="number">0x0a5140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x002ec0</span> <span class="number">0x002ec0</span> R   <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span>     .note.gnu.build-id .note.ABI-tag .rela.plt</span><br><span class="line">   <span class="number">01</span>     .init .plt .text __libc_freeres_fn .fini</span><br><span class="line">   <span class="number">02</span>     .rodata .stapsdt.base .eh_frame .gcc_except_table</span><br><span class="line">   <span class="number">03</span>     .tdata .init_array .fini_array .data.rel.ro .got .got.plt .data __libc_subfreeres __libc_IO_vtables __libc_atexit .bss __libc_freeres_ptrs</span><br><span class="line">   <span class="number">04</span>     .note.gnu.build-id .note.ABI-tag</span><br><span class="line">   <span class="number">05</span>     .tdata .tbss</span><br><span class="line">   <span class="number">06</span></span><br><span class="line">   <span class="number">07</span>     .tdata .init_array .fini_array .data.rel.ro .got</span><br></pre></td></tr></table></figure>
<p>程序运行起来后的实际内存映射情况</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ ./SectionMapping.elf &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">106421</span></span><br><span class="line">~ cat /proc/<span class="number">106421</span>/maps</span><br><span class="line"><span class="number">00400000</span><span class="number">-00401000</span> r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">00401000</span><span class="number">-00480000</span> r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">00480000</span><span class="number">-004</span>a5000 r--p <span class="number">00080000</span> <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">004</span>a6000<span class="number">-004</span>ac000 rw-p <span class="number">000</span>a5000 <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">004</span>ac000<span class="number">-004</span>ad000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="number">01539000</span><span class="number">-0155</span>c000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [heap]</span><br><span class="line"><span class="number">7f</span>fffa319000<span class="number">-7f</span>fffa33a000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">7f</span>fffa367000<span class="number">-7f</span>fffa36a000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vvar]</span><br><span class="line"><span class="number">7f</span>fffa36a000<span class="number">-7f</span>fffa36b000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h1><h2 id="什么是动态链接"><a href="#什么是动态链接" class="headerlink" title="什么是动态链接"></a>什么是动态链接</h2><p>为什么需要动态链接？</p>
<ul>
<li>静态链接浪费内存空间，对任何公共库函数每个函数都要链接进可执行文件</li>
<li>不利于程序的开发和发布，任务静态库更新后，可执行文件需要重新编译</li>
</ul>
<p>什么是动态链接？</p>
<ul>
<li>程序的模块分隔开，形成独立的文件，不再将他们链接在一起；等程序运行时链接需要的模块</li>
<li>program1 和 program2 都依赖 lib.so</li>
<li>program1 运行时发现依赖 lib.so，操作系统将 lib.so 加载至内存，开始链接过程（符号解析、地址定位等</li>
<li>运行 program2，加载 program2 是发现其依赖 lib.so，而此时内存中已经有 lib.so 的 副本，则不需要重新加载，只需要链接 program2 和 lib.so</li>
</ul>
<p>动态链接优势？</p>
<ul>
<li>节省内存</li>
<li>减少物理页面的换入和换出</li>
<li>增加 cpu 缓存命中率</li>
<li>动态的加载各种程序模块（插件开发）</li>
</ul>
<p>缺点？</p>
<ul>
<li>动态链接的版本不一致，api 接口变动等，导致程序不能运行 (DLL Hell)</li>
<li>程序加载时需要代码和数据的重定位（GOT 定位），加上间接寻址，导致程序的运行速度变慢（启动速度）</li>
</ul>
<h2 id="地址无关代码"><a href="#地址无关代码" class="headerlink" title="地址无关代码"></a>地址无关代码</h2><p>编译时指定 <code>-fPIC</code> 可让动态库编译成地址无关（<code>-fpic</code> 和 <code>-fPIC</code> 功能一致，但包小，会出现兼容问题，一般使用 <code>-fPIC</code>)；<br>从静态链接的链接过程中，我们也可以按照静态链接的方式链接动态库，对动态链接中的绝对地址做基址重置；但做基址重置时基址是调用该库的程序的基址，<br>比如 <code>program1</code> 调用库的需要基址重置修改库中的指令地址，而 <code>program2</code> 调用库也需要修改指令地址；<br>这样 <code>program1</code> 和 <code>program2</code> 需要自己维护各自的库指令和数据，失去了动态链接的意义。</p>
<p>地址无关：把指令中需要被修改的部分分离出来，跟数据块放在一起，指令部分可以保持不变，数据部分可以再进程中拥有自己的副本。</p>
<p>共享库中地址引用的方式：</p>
<ul>
<li>模块内部调用和跳转：调用函数和调用者在同一个模块，位置相对固定，使用相对地址调用或寄存器相对调用</li>
<li>模块内部数据访问：.text 和 .data 的相对位置也是固定的，也可以使用相对地址调用</li>
<li>模块间数据访问和模块间调用和跳转</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static int a;</span><br><span class="line">extern int b;       // b 在其他动态模块中</span><br><span class="line">extern void ext();  // ext 函数在其他模块中</span><br><span class="line"></span><br><span class="line">void bar() &#123;</span><br><span class="line">    a = 1;</span><br><span class="line">    b = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void foo() &#123;</span><br><span class="line">    bar();</span><br><span class="line">    ext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中 b 和 ext 的目标地址需要等到装载时才能决定，引入 GOT 表（ GLOBAL Offset Table)，GOT 表存储在 .data 字段，那么 GOT 表和代码段的相对位置可以固定<br>GOT 表存存储需要访问的外部变量的地址，则通过一次间接寻址可以获取 b 的实际地址；但编译时是 GOT 表中的对应项是 0，在程序加载时确定外部模块的地址后才能由<strong>动态链接器</strong>填入具体值</p>
<h2 id="GOT-实现原理"><a href="#GOT-实现原理" class="headerlink" title="GOT 实现原理"></a>GOT 实现原理</h2><p><img src="http://onepiece.nos-eastchina1.126.net/markdown/got.png" alt=":scale 80%"></p>
<hr>
<h2 id="延迟绑定-PLT"><a href="#延迟绑定-PLT" class="headerlink" title="延迟绑定 PLT"></a>延迟绑定 PLT</h2><p>动态链接相对灵活，却牺牲一部分性能</p>
<ul>
<li>全局和静态数据的间接寻址</li>
<li>模块间调用的GOT重定位; 动态链接是运行时完成，寻找并装共享对象，进行符号地址重定位</li>
</ul>
<p>在程序执行前，动态链接会耗费时间解决模块之间的函数引用符号的查找和重定位，然后很多函数可能很少用到，如错误处理函数。 ELF 采用延迟绑定（lazing binding)<br>, <strong>当函数第一次被用到是才进行绑定</strong>，如果没用用到就不绑定。ELF 使用 PLT （procedure linkage table)来实现；在 GOT 实现中，外部变量的引用的间接寻址的值由链接器加载时填入，使用 PLT 可以延迟这个过程。</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/got-plt.png" alt=":scale 100%"></p>
<h2 id="动态链接结构"><a href="#动态链接结构" class="headerlink" title="动态链接结构"></a>动态链接结构</h2><ul>
<li>.interp 共享库使用的解释器，一般为 /lib/ld-linux.so</li>
<li>.dynampic 保存动态链接需要的用到的信息；动态链接符号地址，动态链接字符串地址，重定位表入口等</li>
<li>.dynsym 保存于动态链接相关的符号</li>
<li>.symtab 保存所有的符号</li>
<li>.rela.dyn 对数据引用修正，修正位置位于.got</li>
<li>.rela.plt 对函数引用修正，修正位置位于 .got.plt</li>
</ul>
<h2 id="动态链接过程"><a href="#动态链接过程" class="headerlink" title="动态链接过程"></a>动态链接过程</h2><ul>
<li>ld-linux.so 自举</li>
<li>装载共享对象</li>
<li>重定位和初始化</li>
</ul>
<h2 id="显示运行时链接"><a href="#显示运行时链接" class="headerlink" title="显示运行时链接"></a>显示运行时链接</h2><ul>
<li>dlopen</li>
<li>dlsym</li>
<li>dlerror</li>
<li>dlclose</li>
</ul>
<h2 id="共享库的组织"><a href="#共享库的组织" class="headerlink" title="共享库的组织"></a>共享库的组织</h2><p><strong>命名规范</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libname.so.x.y.z</span><br></pre></td></tr></table></figure></p>
<p>lib 是前缀，中间是库名字</p>
<ul>
<li>x 主版本号 重大升级，不同主版本号不兼容</li>
<li>y 次版本号，增量升级，增加新接口，保持原来符号不变</li>
<li>z 发布版本号，错误修正，性能改进，不添加任何新接口</li>
</ul>
<p><strong>so-name 机制</strong></p>
<p>每个共享库都有一个 so-name, 去掉次版本号和发布版本号，共享库 /lib/libfoo.so.2.6.1 对应的 so-name 为 /lib/libfoo.so.2 的软链接</p>
<p><strong>环境变量</strong></p>
<ul>
<li>LD_LIBRARY_PATH 设置搜索路径，调试动态库</li>
<li>LD_PRELOAD 预先加载覆盖后加载的共享库，用于测试</li>
<li>LD_DEBUG 打印调试信息，打印装载过程</li>
</ul>
<hr>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><ul>
<li>segfault dmseg</li>
<li>错误线索</li>
<li>定位步骤</li>
</ul>
<h2 id="segfault-dmesg"><a href="#segfault-dmesg" class="headerlink" title="segfault dmesg"></a>segfault dmesg</h2><p><a href="https://utcc.utoronto.ca/~cks/space/blog/linux/KernelSegfaultMessageMeaning" target="_blank" rel="noopener">戳我!</a><br><code>segfault</code> 产生时会在系统的日志中记录错误信息，可以用 dmesg 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ dmesg | grep testp</span><br><span class="line">testp[19288]: segfault at 0 ip 0000000000401271 sp 00007fff2ce4d210 error 4 in testp[400000+98000]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>testp[19288]</code> 是发错段错误的 <code>PID</code></li>
<li><code>segfault at 0</code> 表示程序访问地址 <code>0</code> 是发生了段错误；地址 <code>0</code> 可能访问了空指针。</li>
<li><code>ip 0000000000401271</code> 是指令之指针（<code>instruction pointer</code>），在 64-bit x86 下对应的寄存器为 <code>%rip</code></li>
<li><code>sp 00007fff2ce4d210</code> 是栈指针（stack pointer）, 在 64-bit x86 下对应的寄存器为 <code>%rsp</code></li>
<li><code>error 4</code> 是 16 进制的<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/traps.h#n148" target="_blank" rel="noopener">错误码</a>； 一般情况下至少为 4 表示是用户态的错误；4 表示读一个未映射的内存（unmapped area)，6（4+2）表示写一个未映射的内存</li>
<li><code>in testp[400000+98000]</code> 段错误的程序是 <code>testp</code>, 其 <code>ip</code> 所在的虚拟地址范围为 <code>0x400000 ~ 0x400000+0x98000</code>, 0x98000 表示是该程序映射的大小</li>
</ul>
<h2 id="错误线索"><a href="#错误线索" class="headerlink" title="错误线索"></a>错误线索</h2><ul>
<li><p>curl</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vagrant@archlinux:~/nos-openresty  master ✗ curl -v 'http://127.0.0.1:1989?ip=121.193.184.2'</span><br><span class="line">* Rebuilt URL to: http:<span class="comment">//127.0.0.1:1989/?ip=121.193.184.2</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">1989</span> (#<span class="number">0</span>)</span><br><span class="line">&gt; GET /?ip=<span class="number">121.193</span><span class="number">.184</span><span class="number">.2</span> HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1989</span></span><br><span class="line">&gt; User-Agent: curl/<span class="number">7.59</span><span class="number">.0</span></span><br><span class="line">&gt; Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Empty reply from server</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br><span class="line"><span class="comment">curl: (52) Empty reply from server</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>error log</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">11</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">57</span>:<span class="number">43</span> [notice] <span class="number">14393</span>#<span class="number">14393</span>: signal <span class="number">17</span> (SIGCHLD) received from <span class="number">14394</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">11</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">57</span>:<span class="number">43</span> [alert] <span class="number">14393</span>#<span class="number">14393</span>: worker process <span class="number">14394</span> exited on signal <span class="number">11</span> (core dumped)</span><br><span class="line"><span class="number">2019</span>/<span class="number">11</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">57</span>:<span class="number">43</span> [notice] <span class="number">14393</span>#<span class="number">14393</span>: start worker process <span class="number">14566</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>demsg</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">37568.563121</span>] nginx[<span class="number">14394</span>]: segfault at a ip <span class="number">00007f</span>10ef0973fd sp <span class="number">00007f</span>fc1688f480 error <span class="number">6</span> in lipip.so[<span class="number">7f</span>10ef096000+<span class="number">2000</span>]</span><br></pre></td></tr></table></figure>
<p>  这里的 <code>lipip.so[7f10ef096000+2000]</code> 已经表明了是 lipip.so 中的异常，如果没有标识出是 <code>lipip</code> 库的异常，可以根据 maps 看是共享库还是程序本身的异常。<code>7f10ef096000+2000</code> 中<br>  <code>7f10ef096000</code> 是基址偏移量， <code>+2000</code> 标识这个 map 对应的大小。</p>
</li>
</ul>
<h2 id="定位步骤"><a href="#定位步骤" class="headerlink" title="定位步骤"></a>定位步骤</h2><ul>
<li><p>先看下 lipip.so 有没有 dwarf</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vagrant@archlinux:~/reading/lipip  develop ✗ readelf -W -S lipip.so</span><br><span class="line">There are <span class="number">35</span> section headers, starting at offset <span class="number">0x67d0</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .note.gnu.build-id NOTE            <span class="number">00000000000001</span>c8 <span class="number">0001</span>c8 <span class="number">000024</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .gnu.hash         GNU_HASH        <span class="number">00000000000001f</span>0 <span class="number">0001f</span>0 <span class="number">000050</span> <span class="number">00</span>   A  <span class="number">3</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line"></span><br><span class="line">                             ......</span><br><span class="line"></span><br><span class="line">  [<span class="number">11</span>] .text             PROGBITS        <span class="number">00000000000010e0</span> <span class="number">0010e0</span> <span class="number">0008b</span>2 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line"></span><br><span class="line">                             ......</span><br><span class="line"></span><br><span class="line">  [<span class="number">20</span>] .got              PROGBITS        <span class="number">0000000000201f</span>e0 <span class="number">001f</span>e0 <span class="number">000020</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">21</span>] .got.plt          PROGBITS        <span class="number">0000000000202000</span> <span class="number">002000</span> <span class="number">000138</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">22</span>] .data             PROGBITS        <span class="number">0000000000202140</span> <span class="number">002140</span> <span class="number">000060</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">23</span>] .bss              NOBITS          <span class="number">00000000002021</span>a0 <span class="number">0021</span>a0 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">24</span>] .comment          PROGBITS        <span class="number">0000000000000000</span> <span class="number">0021</span>a0 <span class="number">00001</span>a <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">25</span>] .debug_aranges    PROGBITS        <span class="number">0000000000000000</span> <span class="number">0021b</span>a <span class="number">000090</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">26</span>] .debug_info       PROGBITS        <span class="number">0000000000000000</span> <span class="number">00224</span>a <span class="number">001830</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">27</span>] .debug_abbrev     PROGBITS        <span class="number">0000000000000000</span> <span class="number">003</span>a7a <span class="number">000503</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">28</span>] .debug_line       PROGBITS        <span class="number">0000000000000000</span> <span class="number">003f</span>7d <span class="number">00046f</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">29</span>] .debug_str        PROGBITS        <span class="number">0000000000000000</span> <span class="number">0043</span>ec <span class="number">0005</span>a6 <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">30</span>] .debug_loc        PROGBITS        <span class="number">0000000000000000</span> <span class="number">004992</span> <span class="number">000</span>ec9 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">31</span>] .debug_ranges     PROGBITS        <span class="number">0000000000000000</span> <span class="number">00585b</span> <span class="number">000060</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">32</span>] .symtab           SYMTAB          <span class="number">0000000000000000</span> <span class="number">0058</span>c0 <span class="number">0009</span>a8 <span class="number">18</span>     <span class="number">33</span>  <span class="number">57</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">33</span>] .strtab           STRTAB          <span class="number">0000000000000000</span> <span class="number">006268</span> <span class="number">00040</span>e <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">34</span>] .shstrtab         STRTAB          <span class="number">0000000000000000</span> <span class="number">006676</span> <span class="number">000153</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>  如果没有 <code>.debug</code> 开头的 section，说明没有 dwarf 符号，需要到编译机 <code>-g</code> 重新编译。</p>
</li>
<li><p>看程序段的地址分配</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[11] .text             PROGBITS        00000000000010e0 0010e0 0008b2 00  AX  0   0 16</span><br></pre></td></tr></table></figure>
<p>  范围为 <code>0x00000000000010e0 ~ 0000000000001992(0x00000000000010e0+0x0008b2)</code></p>
</li>
<li><p>查看 segfault 错误信息</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">segfault at a ip 00007f10ef0973fd sp 00007ffc1688f480 error 6 in lipip.so[7f10ef096000+2000]</span><br></pre></td></tr></table></figure>
<p>  用 ip 值减去基址偏移:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007f10ef0973fd - 0x7f10ef096000 = 0x13fd</span><br></pre></td></tr></table></figure>
</li>
<li><p>用 addr2line 工具定位错误行号</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant@archlinux:~/reading/lipip  develop ✗ addr2line -e lipip.so 0x13fd</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看代码行号</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 96     ...</span><br><span class="line"> 97     if (s &lt;= e) &#123;</span><br><span class="line"> 98         lua_pushstring(L, s);</span><br><span class="line"> 99         lua_rawseti(L, -2, i);</span><br><span class="line">100     &#125;</span><br><span class="line">101</span><br><span class="line">102     int *p = 10;</span><br><span class="line">103     *p = 0;                         // 修改栈上值</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="运行库"><a href="#运行库" class="headerlink" title="运行库"></a>运行库</h1><h2 id="启动函数"><a href="#启动函数" class="headerlink" title="启动函数"></a>启动函数</h2><p>main 函数并非程序的起点: <code>_start -&gt; _libc_start_main (.init -&gt; rtld_fini -&gt; .fini)-&gt; main -&gt; exit</code></p>
<ul>
<li>crt1.o 是程序的真正入口函数 _start，由它调用 <code>_libc_start_main</code>，包含基本的启动、退出代码。开始叫 crt.0，为强调是链接输入第一个文件更名为 crt0.o， 后来为了兼容 .init 和 .fint 又升级为 crt1.o</li>
<li>由于c++ 出现和 elf 改进，必须在 main 函数之前全局/静态对象的构造，glibc 库在每个目标文件中引入了 .init 和 .fint 段； crti.o 和 crtn.o 帮助 .init 和 .fint 完成构造和清理相关工作</li>
<li>crti.o 和 crtn.o 提供了 .init 和 .finit 的机制， 实际完成构造和析构的是 crtbeginT.o 和 crtend.o</li>
</ul>
<h2 id="运行库-1"><a href="#运行库-1" class="headerlink" title="运行库"></a>运行库</h2><p>运行库（runtime library), C 运行库 CRT</p>
<ul>
<li>启动与退出</li>
<li>标准函数（标准输入、输出；文件；字符；字符串..)</li>
<li>I/O</li>
<li>堆 / 特殊实现 / 调试</li>
</ul>
<h2 id="标准函数变长实现"><a href="#标准函数变长实现" class="headerlink" title="标准函数变长实现"></a>标准函数变长实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define va_list char*</span><br><span class="line">#define va_start(ap,arg) (ap=(va_list)&amp;arg+sizeof(arg))</span><br><span class="line">#define va_arg(ap, t) (*(t*)(ap+=sizeof(t))-sizeof(t))</span><br><span class="line">#define va_end(ap) (ap=(va_list)0)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdarg.h&gt;</span><br><span class="line"></span><br><span class="line">void</span><br><span class="line">foo(char *fmt, ...)</span><br><span class="line">&#123;</span><br><span class="line">    va_list ap;</span><br><span class="line">    int d;</span><br><span class="line">    char c, *s;</span><br><span class="line"></span><br><span class="line">    va_start(ap, fmt);</span><br><span class="line">    while (*fmt)</span><br><span class="line">        switch (*fmt++) &#123;</span><br><span class="line">        case &apos;s&apos;:              /* string */</span><br><span class="line">            s = va_arg(ap, char *);</span><br><span class="line">            printf(&quot;string %s\n&quot;, s);</span><br><span class="line">            break;</span><br><span class="line">        case &apos;d&apos;:              /* int */</span><br><span class="line">            d = va_arg(ap, int);</span><br><span class="line">            printf(&quot;int %d\n&quot;, d);</span><br><span class="line">            break;</span><br><span class="line">        case &apos;c&apos;:              /* char */</span><br><span class="line">            c = (char) va_arg(ap, int);</span><br><span class="line">            printf(&quot;char %c\n&quot;, c);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    va_end(ap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么只有 cdcel 可以实现变长参数，而 stdcall 不能实现变长参数？</p>
<h2 id="CRT-与多线程"><a href="#CRT-与多线程" class="headerlink" title="CRT 与多线程"></a>CRT 与多线程</h2><ul>
<li><p>多线程版本运行库中，线程不安全函数会自动加锁，包括 malloc, printf 等</p>
</li>
<li><p>errno <code># define errno (*__errno_location())</code> 不同的 <code>__errno_location</code> 返回地址不同</p>
</li>
<li><p>线程特有的只是栈（出入栈频繁，不可控）和寄存器（数量少），使用 <code>Thread Local Storage</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__thread int number`</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="系统调用与API"><a href="#系统调用与API" class="headerlink" title="系统调用与API"></a>系统调用与API</h1><p>什么是系统调用？<br>程序运行时，其本身是没有多少æ利去访问系统资源(文件、网络、io 等)的，因系统有限的资源可能被多个不同的程序同时访问，需要系统级的保护和协调。</p>
<p>linux 系统调用<br>使用通用寄存器传递参数，EAX 寄存器传递系统调用号(例如0x80)，EAX=1(exit); EAX=2(fork); EAX=3(IO read); EAX=4(IO write)；<br>系统调用可以绕过 glibc 直接使用（性能考虑)</p>
<p>linux 为了系统的稳定性和安全性分为两种特权级别：用户态和内核态，系统调用运行在内核态，而要使用系统调用时必须有用户态切换到内核态，切换的过程是通过中断实现。</p>
<h2 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h2><p>中断是一个硬件或软件发出的请求，要求 cpu 暂停当前的工作去处理其他事情;<br>中断有两个属性，中断号和中断处理程序，而中断号是有限的，所以 linux 采用中断号和系统调用号组合来实现不通的系统调用</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/interrupt1.png" alt=":scale 90%"></p>
<ul>
<li>触发中断</li>
<li>切换堆栈（用户态和内核态使用不同的栈，切换至当前栈(ESP 寄存器的值）至内核态的栈)</li>
<li>中断处理程序</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/31/OpenResty-Best-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/31/OpenResty-Best-Practice/" itemprop="url">
                  OpenResty Best Practice
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-31 00:01:34 / 修改时间：00:02:09" itemprop="dateCreated datePublished" datetime="2018-10-31T00:01:34+08:00">2018-10-31</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/31/OpenResty-Best-Practice/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/31/OpenResty-Best-Practice/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/10/31/OpenResty-Best-Practice/" class="leancloud_visitors" data-flag-title="OpenResty Best Practice">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#anchor1">OpenResty 发展起源</a></li>
<li><a href="#anchor2">OpenResty 之 lua 编程</a></li>
<li><a href="#anchor3">OpenResty 模块编写</a></li>
<li><a href="#anchor4">OpenResty 核心原理</a></li>
<li><a href="#anchor5">OpenResty hooks</a></li>
<li><a href="#anchor6">OpenResty 开发常见陷阱</a></li>
<li><a href="#anchor7">OpenResty 编程优化</a></li>
<li><a href="#anchor8">OpenResty 易混易错配置解析</a></li>
<li><a href="#anchor9">nginx 维护与更新</a></li>
</ul>
<h2 id="OpenResty-发展起源"><a href="#OpenResty-发展起源" class="headerlink" title="OpenResty 发展起源 "></a>OpenResty 发展起源 <span id="anchor1"></span></h2><p>OpenResty(也称为 ngx_openresty)是一个全功能的 Web 应用服务器。它打包了标准的 nginx 核心，很多的常用的第三方模块，以及它们的大多数依赖项。<br>通过揉和众多设计良好的 nginx 模块，OpenResty 有效地把 nginx 服务器转变为一个强大的 Web 应用服务器，基于它开发人员可以使用 lua 编程语言对 nginx 核心以及现有的各种 nginx C 模块进行脚本编程，构建出可以处理一万以上并发请求的极端高性能的 Web 应用。</p>
<p>OpenResty 致力于将你的服务器端应用完全运行于 nginx 服务器中，充分利用 nginx 的事件模型来进行非阻塞 I/O 通信。不仅仅是和 HTTP 客户端间的网络通信是非阻塞的，与 MySQL、PostgreSQL、Memcached 以及 Redis 等众多后端之间的网络通信也是非阻塞的。<br>因为 OpenResty 软件包的维护者也是其中打包的许多 nginx 模块的作者，所以 OpenResty 可以确保所包含的所有组件可以可靠地协同工作。</p>
<p>OpenResty 最早是雅虎中国的一个公司项目，起步于 2007 年 10 月。当时兴起了 OpenAPI 的热潮，用于满足各种 Web Service 的需求，基于 Perl 和 Haskell 实现；<br>2009 章亦春在加入淘宝数据部门的量子团队，决定对 OpenResty 进行重新设计和彻底重写，并把应用重点放在支持像量子统计这样的 Web 产品上面，这是第二代的 OpenResty，基于 nginx 和 lua 进行开发。</p>
<p>为什么要取 OpenResty 这个名字呢？OpenResty 最早是顺应 OpenAPI 的潮流做的，所以 Open 取自“开放”之意，而 Resty 便是 REST 风格的意思。虽然后来也可以基于 ngx_openresty 实现任何形式的 Web service 或者传统的 Web 应用。</p>
<p>也就是说 nginx 不再是一个简单的静态网页服务器，也不再是一个简单的反向代理了，OpenResty 致力于通过一系列 nginx 模块，把 nginx 扩展为全功能的 Web 应用服务器，目前有两大应用目标：</p>
<ol>
<li>通用目的的 Web 应用服务器。在这个目标下，现有的 Web 应用技术都可以算是和 OpenResty 或多或少有些类似，比如 Nodejs，PHP 等等，但 OpenResty 的性能更加出色。</li>
<li>nginx 的脚本扩展编程，为构建灵活的 Web 应用网关和 Web 应用防火墙等功能提供了极大的便利性。</li>
</ol>
<p>OpenResty 特性概括如下：</p>
<ul>
<li>基于 nginx 的 Web 服务器</li>
<li>打包 nginx 核心、常用的第三方模块及依赖项</li>
<li>使用 lua 对 nginx 进行脚本编程</li>
<li>充分利用 nginx 的事件模型进行非阻塞 I/O 通信</li>
<li>使用 lua 以同步方式进行异步编程</li>
<li>拓展后端通信方式</li>
</ul>
<p>综合 OpenResty 的特性，它不仅具备 nginx 的负载均衡、反向代理及传统 http server 等功能，还可以利用 lua 脚本编程实现路由网关，实现访问认证、流量控制、路由控制及日志处理等多种功能；同时利用 cosocket 拓展和后端(mysql、redis、kafaka)通信后，更可开发通用的 restful api 程序。</p>
<h2 id="OpenResty-之-lua-编程"><a href="#OpenResty-之-lua-编程" class="headerlink" title="OpenResty 之 lua 编程 "></a>OpenResty 之 lua 编程 <span id="anchor2"></span></h2><h3 id="lua-简介"><a href="#lua-简介" class="headerlink" title="lua 简介"></a>lua 简介</h3><p>1993 年在巴西里约热内卢天主教大学诞生了一门编程语言，他们给这门语言取了个浪漫的名字 — lua，在葡萄牙语里代表美丽的月亮。事实证明他们没有糟蹋这个优美的单词，lua 语言正如它名字所预示的那样成长为一门简洁、优雅且富有乐趣的语言。</p>
<p>lua 从一开始就是作为一门方便嵌入(其它应用程序)并可扩展的轻量级脚本语言来设计，因此她一直遵从着简单、小巧、可移植、快速的原则，官方实现完全采用 ANSI C 编写，能以 C 程序库的形式嵌入到宿主程序中。luaJIT 2 和标准 lua 5.1 解释器采用的是著名的 MIT 许可协议。正由于上述特点，所以 lua 在游戏开发、机器人控制、分布式应用、图像处理、生物信息学等各种各样的领域中得到了越来越广泛的应用。其中尤以游戏开发为最，许多著名的游戏，比如 World of Warcraft、大话西游，都采用了 lua 来配合引擎完成数据描述、配置管理和逻辑控制等任务。即使像 Redis 这样中性的内存键值数据库也提供了内嵌用户 lua 脚本的官方支持。</p>
<p>作为一门过程型动态语言，lua 有着如下的特性：</p>
<ol>
<li>变量名没有类型，值才有类型，变量名在运行时可与任何类型的值绑定；</li>
<li>语言只提供唯一一种数据结构，称为表(table)，它混合了数组、哈希，可以用任何类型的值作为 key 和 value。提供了一致且富有表达力的表构造语法，使得 lua 很适合描述复杂的数据；</li>
<li>函数是一等类型，支持匿名函数和正则尾递归(proper tail recursion)；</li>
<li>支持词法定界(lexical scoping)和闭包(closure)；</li>
<li>提供 thread 类型和结构化的协程(coroutine)机制，在此基础上可方便实现协作式多任务；</li>
<li>运行期能编译字符串形式的程序文本并载入虚拟机执行；</li>
<li>通过元表(metatable)和元方法(metamethod)提供动态元机制(dynamic meta-mechanism)，从而允许程序运行时根据需要改变或扩充语法设施的内定语义；</li>
<li>能方便地利用表和动态元机制实现基于原型(prototype-based)的面向对象模型；</li>
<li>从 5.1 版开始提供了完善的模块机制，从而更好地支持开发大型的应用程序；</li>
</ol>
<h3 id="lua-基础数据类型"><a href="#lua-基础数据类型" class="headerlink" title="lua 基础数据类型"></a>lua 基础数据类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(type(&quot;hello world&quot;)) --&gt; output:string</span><br><span class="line">print(type(print))         --&gt; output:function</span><br><span class="line">print(type(true))          --&gt; output:boolean</span><br><span class="line">print(type(360.0))         --&gt; output:number</span><br><span class="line">print(type(nil))           --&gt; output:nil</span><br></pre></td></tr></table></figure>
<h4 id="nil"><a href="#nil" class="headerlink" title="nil"></a>nil</h4><p>nil 是一种类型，lua 将 nil 用于表示“无效值”。一个变量在第一次赋值前的默认值是 nil，将 nil 赋予给一个全局变量就等同于删除它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">local num</span><br><span class="line">print(num)        --&gt; output:nil</span><br><span class="line"></span><br><span class="line">num = 100</span><br><span class="line">print(num)        --&gt; output:100</span><br></pre></td></tr></table></figure>
<h3 id="boolean-true-false"><a href="#boolean-true-false" class="headerlink" title="boolean (true/false)"></a>boolean (true/false)</h3><p>布尔类型，可选值 true/false；lua 中 nil 和 false 为“假”，其它所有值均为“真”，比如 0 和空字符串就是“真”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">local a = true</span><br><span class="line">local b = 0</span><br><span class="line">local c = nil</span><br><span class="line"></span><br><span class="line">if a then</span><br><span class="line">    print(&quot;a&quot;)        --&gt; output:a</span><br><span class="line">else</span><br><span class="line">    print(&quot;not a&quot;)    -- 这个没有执行</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if b then</span><br><span class="line">    print(&quot;b&quot;)        --&gt; output:b</span><br><span class="line">else</span><br><span class="line">    print(&quot;not b&quot;)    -- 这个没有执行</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if c then</span><br><span class="line">    print(&quot;c&quot;)        -- 这个没有执行</span><br><span class="line">else</span><br><span class="line">    print(&quot;not c&quot;)    --&gt; output:not c</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="number"><a href="#number" class="headerlink" title="number"></a>number</h3><p>Number 类型用于表示实数，和 C/C++ 里面的 double 类型很类似。可以使用数学函数 math.floor(向下取整)和 math.ceil(向上取整)进行取整操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">local order = 3.99</span><br><span class="line">local score = 98.01</span><br><span class="line">print(math.floor(order))   --&gt; output:3</span><br><span class="line">print(math.ceil(score))    --&gt; output:99</span><br></pre></td></tr></table></figure>
<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><p>和其他语言 string 大同小异</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">local str1 = &apos;hello world&apos;</span><br><span class="line">local str2 = &quot;hello lua&quot;</span><br><span class="line">local str3 = [[&quot;add\name&quot;,&apos;hello&apos;]]</span><br><span class="line">local str4 = [=[string have a [[]].]=]</span><br><span class="line"></span><br><span class="line">print(str1)    --&gt; output:hello world</span><br><span class="line">print(str2)    --&gt; output:hello lua</span><br><span class="line">print(str3)    --&gt; output:&quot;add\name&quot;,&apos;hello&apos;</span><br><span class="line">print(str4)    --&gt; output:string have a [[]].</span><br></pre></td></tr></table></figure>
<h3 id="table-数组、字典"><a href="#table-数组、字典" class="headerlink" title="table (数组、字典)"></a>table (数组、字典)</h3><p>Table 类型实现了一种抽象的“关联数组”。“关联数组”是一种具有特殊索引方式的数组，索引通常是字符串(string)或者 number 类型，但也可以是除 nil 以外的任意类型的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">local corp = &#123;</span><br><span class="line">    web = &quot;www.google.com&quot;,             -- 索引为字符串，key = &quot;web&quot;,</span><br><span class="line">                                        --             value = &quot;www.google.com&quot;</span><br><span class="line">    telephone = &quot;12345678&quot;,             -- 索引为字符串</span><br><span class="line">    staff = &#123;&quot;Jack&quot;, &quot;Scott&quot;, &quot;Gary&quot;&#125;,  -- 索引为字符串，值也是一个表</span><br><span class="line">    100876,                             -- 相当于 [1] = 100876，此时索引为数字</span><br><span class="line">                                        --       key = 1, value = 100876</span><br><span class="line">    100191,                             -- 相当于 [2] = 100191，此时索引为数字</span><br><span class="line">    [10] = 360,                         -- 直接把数字索引给出</span><br><span class="line">    [&quot;city&quot;] = &quot;Beijing&quot;                -- 索引为字符串</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print(corp.web)                         --&gt; output:www.google.com</span><br><span class="line">print(corp[&quot;telephone&quot;])                --&gt; output:12345678</span><br><span class="line">print(corp[2])                          --&gt; output:100191</span><br><span class="line">print(corp[&quot;city&quot;])                     --&gt; output:&quot;Beijing&quot;</span><br><span class="line">print(corp.staff[1])                    --&gt; output:Jack</span><br><span class="line">print(corp[10])                         --&gt; output:360</span><br></pre></td></tr></table></figure>
<p>在内部实现上，table 通常实现为一个哈希表、一个数组、或者两者的混合。具体的实现为何种形式，动态依赖于具体的 table 的键分布特点。</p>
<h3 id="function"><a href="#function" class="headerlink" title="function"></a>function</h3><p>在 lua 中，函数也是一种数据类型，函数可以存储在变量中，可以通过参数传递给其他函数，还可以作为其他函数的返回值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">local function foo()</span><br><span class="line">    print(&quot;in the function&quot;)</span><br><span class="line">    -- dosomething()</span><br><span class="line">    local x = 10</span><br><span class="line">    local y = 20</span><br><span class="line">    return x + y</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local a = foo    -- 把函数赋给变量</span><br><span class="line"></span><br><span class="line">print(a())</span><br><span class="line"></span><br><span class="line">-- output:</span><br><span class="line">in the function</span><br><span class="line">30</span><br></pre></td></tr></table></figure>
<h3 id="lua-表达式"><a href="#lua-表达式" class="headerlink" title="lua 表达式"></a>lua 表达式</h3><table>
<thead>
<tr>
<th>算术运算符</th>
<th>说明</th>
<th>关系运算符</th>
<th>说明</th>
<th>逻辑运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加法</td>
<td>&lt;</td>
<td>小于</td>
<td>and</td>
<td>逻辑与</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
<td>&gt;</td>
<td>大于</td>
<td>or</td>
<td>逻辑或</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
<td>&lt;=</td>
<td>小于等于</td>
<td>not</td>
<td>逻辑非</td>
</tr>
<tr>
<td>/</td>
<td>除法</td>
<td>&gt;=</td>
<td>大于等于</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>^</td>
<td>指数</td>
<td>~=</td>
<td>不等于</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>%</td>
<td>取模</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>note: lua 中的<code>不等于</code>用 <code>~=</code> 表示， 和其他语言的 <code>!=</code> 不一致</p>
</blockquote>
<h3 id="lua-流程控制"><a href="#lua-流程控制" class="headerlink" title="lua 流程控制"></a>lua 流程控制</h3><p>lua 的流程控制结构和 python 类似，有几个特例:</p>
<ul>
<li>lua 中的 elseif 需要连写，中间不能有空行；python 中写法是 <code>elif</code></li>
<li>lua 中没有 continue 流控</li>
</ul>
<h4 id="if-else-elseif"><a href="#if-else-elseif" class="headerlink" title="if/else/elseif"></a>if/else/elseif</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if a = 1 then</span><br><span class="line">	print(&quot;1&quot;)</span><br><span class="line">elseif a == 2 then</span><br><span class="line">	print(&quot;2&quot;)</span><br><span class="line">else</span><br><span class="line">	print(&quot;3&quot;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="while"><a href="#while" class="headerlink" title="while"></a>while</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while a &gt; 1 do</span><br><span class="line">	if a == 5 then</span><br><span class="line">		break</span><br><span class="line">    end</span><br><span class="line">	a = a + 1</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local i = 0</span><br><span class="line">repeat</span><br><span class="line">	print(i)</span><br><span class="line">    if i == 5 then</span><br><span class="line">		break</span><br><span class="line">    end</span><br><span class="line">until true</span><br></pre></td></tr></table></figure>
<h4 id="for-break"><a href="#for-break" class="headerlink" title="for/break"></a>for/break</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">local t = &#123; a = 1, b = 2&#125;</span><br><span class="line">for k, v in pairs(t) do  -- 遍历字典</span><br><span class="line">	print(k, v)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local t = &#123;1, 2&#125;</span><br><span class="line">for k, v in ipairs(t) do -- 遍历整型数组</span><br><span class="line">	print(k, v)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">for i = 1, 10 do        -- range 循环</span><br><span class="line">	print(i)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="return"><a href="#return" class="headerlink" title="return"></a>return</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local function foo(arg)</span><br><span class="line">	if arg == &quot;&quot; then</span><br><span class="line">		return nil</span><br><span class="line">	end</span><br><span class="line"></span><br><span class="line">	return &quot;bar&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="OpenResty-模块编写"><a href="#OpenResty-模块编写" class="headerlink" title="OpenResty 模块编写 "></a>OpenResty 模块编写 <span id="anchor3"></span></h2><p>编写一个 <code>access.lua</code> 模块，源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">local _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line">_M.check = function()</span><br><span class="line">	if ngx.var.http_host == &quot;foo.bar.com&quot; then</span><br><span class="line">		ngx.exit(403)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">return _M       -- 注意 return _M，返回 table 表示的模块</span><br></pre></td></tr></table></figure></p>
<p>在 <code>access_by_lua</code> 的 nginx hook 中调用 <code>access</code> 模块：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">access_by_lua_block &#123;</span><br><span class="line">	local rule = require &quot;access&quot;   -- require 中不需要加 `.lua` 后缀</span><br><span class="line">	rule.check()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenResty-核心原理"><a href="#OpenResty-核心原理" class="headerlink" title="OpenResty 核心原理 "></a>OpenResty 核心原理 <span id="anchor4"></span></h2><h3 id="nginx-进程模型"><a href="#nginx-进程模型" class="headerlink" title="nginx 进程模型"></a>nginx 进程模型</h3><p>nginx 是一个 master + 多个 worker 进程模型；master 进程负责管理和监控 worker 进程，如加载和解析配置文件，重启 worker 进程，更新二进制文件等。 worker 进程负责处理请求，每个 worker 地位和功能相同，内部按照 epoll + callback 方式实现并发连接处理；整体架构图如下：<br><img src="http://onepiece.nos-eastchina1.126.net/images/nginx-architecture.png?imageView&amp;thumbnail=900x0" alt="nginx 架构模型"></p>
<h3 id="nginx-请求处理流程"><a href="#nginx-请求处理流程" class="headerlink" title="nginx 请求处理流程"></a>nginx 请求处理流程</h3><p>每个 worker 进程都分阶段处理 http 请求，简单概括为初始化请求 -&gt; 处理请求行 -&gt; 后端交互 -&gt; 响应头处理 -&gt; 响应包体处理 -&gt; 打印日志等几个阶段。其中处理响应体阶段又可以挂载多个不同的 filter。具体的请求阶段可以参见<br><a href="http://nginx.org/en/docs/dev/development_guide.html#http_phases" target="_blank" rel="noopener">nginx Phase</a>, nginx 请求处理流程如下图：<br><img src="https://onepiece.nos-eastchina1.126.net/images/nginx-http-request.png?imageView&amp;thumbnail=900x0" alt="nginx请求处理流程"></p>
<h3 id="nginx-事件机制"><a href="#nginx-事件机制" class="headerlink" title="nginx 事件机制"></a>nginx 事件机制</h3><p>nginx 的事件驱动机制是对 epoll 驱动的封装，但其本质还是 epoll + callback 方式：<br><img src="https://onepiece.nos-eastchina1.126.net/images/nginx-event-loop.png?imageView&amp;thumbnail=900x0" alt="nginx事件机制"></p>
<h3 id="lua-协程"><a href="#lua-协程" class="headerlink" title="lua 协程"></a>lua 协程</h3><table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>coroutine.create()</td>
<td>创建 coroutine，返回 coroutine，参数是一个函数，当和 resume 配合使用的时候就唤醒函数调用</td>
</tr>
<tr>
<td>coroutine.resume()</td>
<td>重启 coroutine，和 create 配合使用</td>
</tr>
<tr>
<td>coroutine.yield()</td>
<td>挂起 coroutine，将 coroutine 设置为挂起状态，这个和 resume 配合使用能有很多有用的效果</td>
</tr>
<tr>
<td>coroutine.status()</td>
<td>查看 coroutine 的状态。注：coroutine 的状态有四种：dead，suspend，running，normal</td>
</tr>
</tbody>
</table>
<h4 id="coroutine-create-f"><a href="#coroutine-create-f" class="headerlink" title="coroutine.create(f)"></a>coroutine.create(f)</h4><p>创建一个主体函数为 f 的新协程。f 必须是一个 lua 的函数。返回这个新协程，它是一个类型为 “thread” 的对象，创建后并不会启动该协程。</p>
<h4 id="coroutine-resume-co-val1-…"><a href="#coroutine-resume-co-val1-…" class="headerlink" title="coroutine.resume(co, [, val1, …])"></a>coroutine.resume(co, [, val1, …])</h4><p>开始或继续协程 co 的运行。当第一次执行一个协程时，他会从主函数处开始运行。val1, … 这些值会以参数形式传入主体函数。如果该协程被挂起，resume 会重新启动它；val1, … 这些参数会作为挂起点的返回值。如果协程运行起来没有错误，resume 返回 true 加上传给 yield 的所有值 (当协程挂起)，或是主体函数的所有返回值(当协程中止)。</p>
<h4 id="coroutine-yield-…"><a href="#coroutine-yield-…" class="headerlink" title="coroutine.yield(…)"></a>coroutine.yield(…)</h4><p>挂起正在调用的协程的执行。 传递给 yield 的参数都会转为 resume 的额外返回值。</p>
<h4 id="coroutine-status-co"><a href="#coroutine-status-co" class="headerlink" title="coroutine.status(co)"></a>coroutine.status(co)</h4><p>以字符串形式返回协程 co 的状态：</p>
<ul>
<li>当协程正在运行(它就是调用 status 的那个) ，返回 “running”；</li>
<li>如果协程调用 yield 挂起或是还没有开始运行，返回 “suspended”；</li>
<li>如果协程是活动的，都并不在运行(即它正在延续其它协程)，返回 “normal”；</li>
<li>如果协程运行完主体函数或因错误停止，返回 “dead”。</li>
</ul>
<h4 id="协程实例-生产者消费者"><a href="#协程实例-生产者消费者" class="headerlink" title="协程实例(生产者消费者)"></a>协程实例(生产者消费者)</h4><p>使用协程实现生产者消费者：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">local function produce()</span><br><span class="line">    while true do</span><br><span class="line">        local x = io.read()</span><br><span class="line">        coroutine.yield(x)       -- 挂起协程</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local producer = coroutine.create(produce)  -- 创建协程</span><br><span class="line"></span><br><span class="line">local function receive()</span><br><span class="line">    local status, value = coroutine.resume(producer)  -- 执行协程</span><br><span class="line">    return value</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local function consumer()</span><br><span class="line">    while true do</span><br><span class="line">        local x = receive()</span><br><span class="line">        io.write(x, &quot;\n&quot;)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">consumer() -- loop</span><br></pre></td></tr></table></figure></p>
<h3 id="lua-与-c-堆栈交互"><a href="#lua-与-c-堆栈交互" class="headerlink" title="lua 与 c 堆栈交互"></a>lua 与 c 堆栈交互</h3><p>lua 虚拟机常嵌入 C 程序中运行，对于 C 程序来说，lua 虚拟机就是一个子进程。lua 将所有状态都保存在 lua_State 类型中，所有的 C API 都要求传入一个指向该结构的指针。我们根据这个指针来获取 lua 虚拟机(也就是子进程)的状态。</p>
<p>虚拟机内部与外部的 C 程序发生数据交换主要是通过一个公用栈实现的，也就是说 lua 虚拟机和 C 程序公用一个栈，双方都可以压栈或读取数据。一方压入，另一方弹出就能实现数据的交换。</p>
<p>在 c 中，lua 堆栈就是一个 struct，堆栈索引方式可能是正数也可能是负数，区别是：正数索引 1 永远表示栈底，负数索引 -1 永远表示栈顶。<br>堆栈的默认大小是 20，可以用 lua_checkstack 修改，用 lua_gettop 则可以获得栈里的元素数目。</p>
<h4 id="C-调用-lua"><a href="#C-调用-lua" class="headerlink" title="C 调用 lua"></a>C 调用 lua</h4><ul>
<li><p>在 C 中创建 lua 虚拟机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_State *luaL_newstate (void)</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载 lua 的库函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void luaL_openlibs (lua_State *L);</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载 lua 文件，使用接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int luaL_dofile (lua_State *L, const char *filename);</span><br></pre></td></tr></table></figure>
</li>
<li><p>开始交互，lua 定义一个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function test_func_add(a, b) return a + b end</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果你的 lua_State 是全局变量，那么每次对堆栈有新操作时务必使用lua_settop(lua_State, -1)将偏移重新置到栈顶</p>
</li>
<li><p>去lua文件中取得test_func_add方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void lua_getglobal (lua_State *L, const char *name);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数压栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_pushnumber</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 pcall 调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int lua_pcall (lua_State *L, int nargs, int nresults, int msg);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>完整示例，先编写一个 foo.lua 文件，在文件中实现 <code>test_func_add</code> 方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function test_func_add(a, b)</span><br><span class="line">    return a + b</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>接下来在 C 代码中调用 foo.lua:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">lua_State* init_lua()</span><br><span class="line">&#123;</span><br><span class="line">    lua_State* s_lua = luaL_newstate();</span><br><span class="line">    if (!s_lua) &#123;</span><br><span class="line">        printf(&quot;luaL_newstate failed!\n&quot;);</span><br><span class="line">        exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line">    luaL_openlibs(s_lua);</span><br><span class="line"></span><br><span class="line">    return s_lua;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool load_lua_file(lua_State* s_lua, const char* lua_file)</span><br><span class="line">&#123;</span><br><span class="line">    if (luaL_dofile(s_lua, lua_file) != 0) &#123;</span><br><span class="line">        printf(&quot;LOAD LUA %s %s\n&quot;, lua_file, BOOT_FAIL);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;LOAD LUA %s %s\n&quot;, lua_file, BOOT_OK);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int proc_add_operation(lua_State* s_lua, int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">    lua_settop(s_lua, -1);</span><br><span class="line">    lua_getglobal(s_lua, &quot;test_func_add&quot;);</span><br><span class="line">    lua_pushnumber(s_lua, a);</span><br><span class="line">    lua_pushnumber(s_lua, b);</span><br><span class="line"></span><br><span class="line">    int val = lua_pcall(s_lua, 2, 1, 0);</span><br><span class="line">    if (val) &#123;</span><br><span class="line">        printf(&quot;lua_pcall_error %d\n&quot;, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (int)lua_tonumber(s_lua, -1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    lua_State* s_lua =init_lua();</span><br><span class="line">    if (!load_lua_file(s_lua, &quot;foo&quot;)) &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proc_add_operation(s_lua, 1, 2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="lua-调用-c"><a href="#lua-调用-c" class="headerlink" title="lua 调用 c"></a>lua 调用 c</h4><ul>
<li><p>定义谁先实现 C 接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define target 300</span><br><span class="line">static int l_test_check_value(lua_State * l)</span><br><span class="line">&#123;</span><br><span class="line">    int num = lua_tointeger(l, -1);</span><br><span class="line">    bool check = (num == target);</span><br><span class="line">    lua_pushboolean(l, check);</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lua 虚拟启动时候，注册加载 C 接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_register(s_lua, &quot;test_check_value&quot;, l_test_check_value);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 lua 代码中调用注册的 C 接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function test_func_check(a)</span><br><span class="line">    local val = test_check_value(a)</span><br><span class="line">    return val</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="lua-协程与-nginx-事件机制结合"><a href="#lua-协程与-nginx-事件机制结合" class="headerlink" title="lua 协程与 nginx 事件机制结合"></a>lua 协程与 nginx 事件机制结合</h3><p>文章前部分用大量篇幅阐述了 lua 和 nginx 的相关知识，包括 nginx 的进程架构，nginx 的事件循环机制，lua 协程，lua 协程如何与 C 实现交互；在了解这些知识之后，本节阐述 lua 协程是如何和 nginx 的事件机制协同工作。</p>
<p>从 nginx 的架构和事件驱动机制来看, nginx 的并发处理模型概括为：单 worker + 多连接 + epoll + callback。<br>即每个 nginx worker 同时处理了大量连接，每个连接对应一个 http 请求，一个 http 请求对应 nignx 中的一个结构体(ngx_http_request_t):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_http_request_s &#123;</span><br><span class="line">    uint32_t                          signature;         /* &quot;HTTP&quot; */</span><br><span class="line"></span><br><span class="line">    ngx_connection_t                 *connection;</span><br><span class="line"></span><br><span class="line">    void                            **ctx;</span><br><span class="line">    void                            **main_conf;</span><br><span class="line">    void                            **srv_conf;</span><br><span class="line">    void                            **loc_conf;</span><br><span class="line"></span><br><span class="line">    ngx_http_event_handler_pt         read_event_handler;</span><br><span class="line">    ngx_http_event_handler_pt         write_event_handler;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结构体中的核心成员为 <code>ngx_connection_t *connection</code>，其定义如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_connection_s &#123;</span><br><span class="line">    void               *data;</span><br><span class="line">    ngx_event_t        *read;      // epoll 读事件对应的结构体成员</span><br><span class="line">    ngx_event_t        *write;     // epoll 写事件对应的结构体成员</span><br><span class="line"></span><br><span class="line">    ngx_socket_t        fd;        // tcp 对应的 socket fd</span><br><span class="line"></span><br><span class="line">    ngx_recv_pt         recv;</span><br><span class="line">    ngx_send_pt         send;</span><br><span class="line">    ngx_recv_chain_pt   recv_chain;</span><br><span class="line">    ngx_send_chain_pt   send_chain;</span><br><span class="line"></span><br><span class="line">    ngx_listening_t    *listening;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从如上结构体可知，每个请求中对应的 <code>ngx_connection_t</code> 中的读写事件和 epoll 关联；nginx epoll 的事件处理核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   events = epoll_wait(ep, event_list, (int) nevents, timer);</span><br><span class="line">   for (i = 0; i &lt; events; i++) &#123;</span><br><span class="line">       c = event_list[i].data.ptr;</span><br><span class="line"></span><br><span class="line">       instance = (uintptr_t) c &amp; 1;</span><br><span class="line">       c = (ngx_connection_t *) ((uintptr_t) c &amp; (uintptr_t) ~1); // epoll 获取激活事件，将事件转换成 ngx_connection_t</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">       rev = c-&gt;read;</span><br><span class="line">       rev-&gt;handler(rev);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">       wev = c-&gt;write;</span><br><span class="line">       wev-&gt;handler(ev);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx epoll loop 中调用 <code>epoll_wait</code> 获取 epoll 接管的激活事件，并通过 c 的指针强转，得到 ngx_connection_t 获取对应的连接和连接上对应的读写事件的回调函数，即通过 C 结构体变量成员之间的相关关联来串联请求和事件驱动，实现请求的并发处理；这里其实和高级语言的面向对象的写法如出一辙，只是模块和成员变量之间的获取方式的差异。</p>
<p>如果引入 lua 的协程机制，在 lua 代码中出现阻塞的时候，主动调用 coroutine.yield 将自身挂起，待阻塞操作恢复时，再将挂起的协程调用 coroutine.resume 恢复则可以避免在 lua 代码中写回调；而何时恢复协程可以交由 c 层面的 epoll 机制来实现，则可以实现事件驱动和协程之间的关联。现在我们只需要考虑，如何将 lua_State 封装的 lua land 和 C land 中的 epoll 机制融合在一起。</p>
<p>事实上 lua-nginx-module 确实是按照这种方式来处理协程与 nginx 事件驱动之间的关系，lua-nginx-module 为每个 nginx worker 生成了一个 lua_state 虚拟机，即每个 worker 绑定一个 lua 虚拟机，当需要 lua 脚本介入请求处理流程时，基于 worker 绑定的虚拟机创建 lua_coroutine 来处理逻辑，当阻塞发生、需要挂起时或者处理逻辑完成时挂起自己，等待下次 epoll 调度时再次唤醒协程执行。如下是 <code>rewrite_by_lua</code> 核心代码部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">tatic ngx_int_t</span><br><span class="line">ngx_http_lua_rewrite_by_chunk(lua_State *L, ngx_http_request_t *r)</span><br><span class="line">&#123;</span><br><span class="line">    co = ngx_http_lua_new_thread(r, L, &amp;co_ref);</span><br><span class="line"></span><br><span class="line">    lua_xmove(L, co, 1);</span><br><span class="line">    ngx_http_lua_get_globals_table(co);</span><br><span class="line">    lua_setfenv(co, -2);</span><br><span class="line"></span><br><span class="line">    ngx_http_lua_set_req(co, r);       // 此处设置协程与 ngx_http_request_t 之间的关系</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    rc = ngx_http_lua_run_thread(L, r, ctx, 0);  // 运行 lua 脚本处理 rewrite 逻辑</span><br><span class="line"></span><br><span class="line">    if (rc == NGX_ERROR || rc &gt; NGX_OK) &#123;</span><br><span class="line">        return rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码片段中我们看到了协程与 ngx 请求之间的绑定关系，那么只要在 ngx_http_lua_run_thread 函数中（实际上是在 lua 脚本中）处理何时挂起 lua 的执行即可。大部分时候我们在 lua 中的脚本工作类型分两种，一种是基于请求信息的逻辑改写，一种是基于 tcp 连接的后端交互。逻辑改写往往不会发生 io 阻塞，即当前脚本很快执行完成后回到 C land，不需要挂起再唤醒的流程。而对于方式二，lua-nginx-module 提供了 cosocket api，<br>它封装了 tcp api，并且会在合适的时候（coroutine.yield 的调用发生在 IO 异常，读取包体完毕，或者 proxy_buffers 已满等情形，具体的实现读者可以参考 <a href="https://github.com/openresty/lua-nginx-module/blob/master/src/ngx_http_lua_socket_tcp.c" target="_blank" rel="noopener">ngx_http_lua_socket_tcp.c</a> 源码）调用 coroutine.yield 方法 。<br><img src="https://onepiece.nos-eastchina1.126.net/images/lua-coroutines.png?imageView&amp;thumbnail=900x0" alt="lua-corotine"></p>
<p>综上所述，结合lua 协程和 nginx 事件驱动机制，使用 OpenResty 可以使用 lua 脚本方便的扩展 nignx 的功能。</p>
<h2 id="OpenResty-hooks-编程钩子"><a href="#OpenResty-hooks-编程钩子" class="headerlink" title="OpenResty hooks (编程钩子) "></a>OpenResty hooks (编程钩子) <span id="anchor5"></span></h2><p><img src="https://onepiece.nos-eastchina1.126.net/images/lua-resty-phase.png?imageView&amp;thumbnail=900x0" alt="lua-resty-phase"></p>
<h3 id="init-by-lua"><a href="#init-by-lua" class="headerlink" title="init_by_lua"></a>init_by_lua</h3><p>该阶段主要用于预加载一些 lua 模块， 如加载全局 json 模块：<code>require &#39;cjson.safe&#39;</code>；设置全局的 <code>lua_share_dict</code> 等，并且可以利用操作系统的 copy-on-write 机制；reload nginx 会重新加载该阶段的代码。</p>
<h3 id="init-worker-by-lua"><a href="#init-worker-by-lua" class="headerlink" title="init_worker_by_lua"></a>init_worker_by_lua</h3><p>该阶段可用于为每个 worker 设置独立的定时器，设置心跳检查等。</p>
<h3 id="rewrite-by-lua"><a href="#rewrite-by-lua" class="headerlink" title="rewrite_by_lua"></a>rewrite_by_lua</h3><p>实际场景中应用最多的一个 hooks 之一，可用于请求重定向相关的逻辑，如改写 host 头，改写请求参数和请求路径等</p>
<h3 id="access-by-lua"><a href="#access-by-lua" class="headerlink" title="access_by_lua"></a>access_by_lua</h3><p>该阶段可用于实现访问控制相关的逻辑，如动态限流、限速，防盗链等</p>
<h3 id="content-by-lua"><a href="#content-by-lua" class="headerlink" title="content_by_lua"></a>content_by_lua</h3><p>该阶段用于生成 http 请求的内容，和 proxy_pass 指令冲突；二者在同一个阶段只能用一个。该阶段可用于动态的后端交互，如 mysql、redis、kafaka 等；也可用于动态的  http 内容生成，如使用 lua 实现 c 的 slice 功能，完成大文件的分片切割。</p>
<h3 id="banalce-by-lua"><a href="#banalce-by-lua" class="headerlink" title="banalce_by_lua"></a>banalce_by_lua</h3><p>该阶段可用于动态的设置 proxy_pass 的上游地址，例如用 lua 实现一个带监控检测机制的一致性 hash 轮序后端算法，根据上游的响应动态设置该地址是否可用。</p>
<h3 id="body-filter-by-lua"><a href="#body-filter-by-lua" class="headerlink" title="body_filter_by_lua"></a>body_filter_by_lua</h3><p>用于过滤和加工响应包体，如对 chunk 模式的包体进行 gzip; 也可以根据包体的大小来动态设置 ngx.var.limit_rate.</p>
<h3 id="header-filter-by-lua"><a href="#header-filter-by-lua" class="headerlink" title="header_filter_by_lua"></a>header_filter_by_lua</h3><p>调整发送给 client 端的响应头，也是最常用的 hooks 之一；比如设置响应的 server 头，修缓存头 <code>cache-control</code> 等。</p>
<h3 id="log-by-lua"><a href="#log-by-lua" class="headerlink" title="log_by_lua"></a>log_by_lua</h3><p>一方面可以设置 nginx 日志输出的字段值，另一方面我们也可以用 <code>cosocket</code> 将日志信息发送到指定的 http server；因响应头和响应体已发送给客户端，该阶段的操作不会影响到客户端的响应速度。</p>
<h2 id="OpenResty-之-lua-编写常见陷阱"><a href="#OpenResty-之-lua-编写常见陷阱" class="headerlink" title="OpenResty 之 lua 编写常见陷阱 "></a>OpenResty 之 lua 编写常见陷阱 <span id="anchor6"></span></h2><ul>
<li>elseif，区别于 else if；</li>
<li>and &amp; or，不支持问号表达式；<a href="http://anyfeel.cn/2016/09/25/lua-and-or" target="_blank" rel="noopener">lua 中 0 表示 <code>true</code></a>；</li>
<li>no continue，lua 中不支持 <code>continue</code> 语法；需要用 if 和 else 语句实现；</li>
<li>. &amp; :，lua 中 object.method 和 object:method 行为不同，object:method 为语法糖，会扩展成第一个参数为 self</li>
<li>forgot return _M，在编写模块的时候如果最后忘记 return _M, 调用时会提示尝试对 string 调用方法的异常</li>
</ul>
<h2 id="OpenResty-编程优化"><a href="#OpenResty-编程优化" class="headerlink" title="OpenResty 编程优化 "></a>OpenResty 编程优化 <span id="anchor7"></span></h2><ul>
<li>do local statement，尽量使用 local 化的变量声明，加速变量索引速度的同时避免全局命名空间的污染；</li>
<li>do not use blocked api，不要调用会阻塞 lua 协程的 api，比如 lua 原生的 socket，会造成 nginx worker block；</li>
<li>use ngx.ctx instead of ngx.var，<code>ngx.var</code> 会调用 <code>ngx.var</code> 的变量索引系统，比 <code>ngx.ctx</code> 低效很多；</li>
<li><code>decrease table resize</code>，避免 lua table 表的 resize 操作，可以用 luajit 事先声明指定大小的 table。比如频繁的 lua 字符串相加的 <code>..</code> 操作，当 lua 预分配内存不够时，会重新动态扩容(和 c++ vector 类型)，会造成低效；</li>
<li>use lua-resty-core，使用 <code>lua-resty-core</code> api，该部分 api 用 luajit 的 ffi 实现比直接的 C 和 lua 交互高效；</li>
<li>use jit support function，少用不可 jit 加速的函数，那些函数不能 jit 支持，可以参看 luajit 文档。</li>
<li>ffi，对自己实现的 C 接口，也建议用 ffi 暴露出接口给 lua 调用。</li>
</ul>
<h2 id="nginx-易混易错配置说明"><a href="#nginx-易混易错配置说明" class="headerlink" title="nginx 易混易错配置说明 "></a>nginx 易混易错配置说明 <span id="anchor8"></span></h2><h3 id="so-keepalive"><a href="#so-keepalive" class="headerlink" title="so_keepalive"></a>so_keepalive</h3><p>用于 listen 中，探测连接保活; 采用TCP连接的C/S模式软件，连接的双方在连接空闲状态时，如果任意一方意外崩溃、当机、网线断开或路由器故障，另一方无法得知TCP连接已经失效，除非继续在此连接上发送数据导致错误返回。很多时候，这不是我们需要的。我们希望服务器端和客户端都能及时有效地检测到连接失效，然后优雅地完成一些清理工作并把错误报告给用户。</p>
<p>如何及时有效地检测到一方的非正常断开，一直有两种技术可以运用。一种是由TCP协议层实现的Keepalive，另一种是由应用层自己实现的心跳包。</p>
<p>TCP默认并不开启Keepalive功能，因为开启 Keepalive 功能需要消耗额外的宽带和流量，尽管这微不足道，但在按流量计费的环境下增加了费用，另一方面，Keepalive设置不合理时可能会因为短暂的网络波动而断开健康的TCP连接。并且，默认的Keepalive超时需要7,200,000 milliseconds，即2小时，探测次数为 5 次。系统默认的 <code>keepalive</code> 配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcpkeepaliveintvl = 75</span><br><span class="line">net.ipv4.tcpkeepaliveprobes = 5</span><br><span class="line">net.ipv4.tcpkeepalivetime = 7200</span><br></pre></td></tr></table></figure></p>
<p>如果在 listen 的时候不设置 so_keepalive 则使用了系统默认的 keepalive 探测保活机制，需要 2 小时才能清理掉这种异常连接；如果在 listen 指令中加入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">so_keepalive=30m::10</span><br></pre></td></tr></table></figure></p>
<p>可设置如果连接空闲了半个小时后每 75s 探测一次，如果超过 10 次 探测失败，则释放该连接。</p>
<h3 id="sendfile-directio"><a href="#sendfile-directio" class="headerlink" title="sendfile/directio"></a>sendfile/directio</h3><p>sendfile</p>
<blockquote>
<p>copies data between one file descriptor and another. Because this copying is done within the kernel, sendfile() is more efficient than the combination of read(2) and write(2), which would require transferring data to and from user space.</p>
</blockquote>
<p>从 <code>Linux</code> 的文档中可以看出，当 nginx 有磁盘缓存文件时候，可以利用 sendfile 特性将磁盘内容直接发送到网卡避免了用户态的读写操作。</p>
<p>directio</p>
<blockquote>
<p>Enables the use of the O_DIRECT flag (FreeBSD, Linux), the F_NOCACHE flag (macOS), or the directio() function (Solaris), when reading files that are larger than or equal to the specified size. The directive automatically disables (0.7.15) the use of sendfile for a given request</p>
</blockquote>
<p>写文件时不经过 Linux 的文件缓存系统，不写 pagecache, 直接写磁盘扇区。启用aio时会自动启用directio, 小于directio定义的大小的文件则采用 sendfile 进行发送，超过或等于 directio 定义的大小的文件，将采用 aio 线程池进行发送，也就是说 aio 和 directio 适合大文件下载。因为大文件不适合进入操作系统的 buffers/cache,这样会浪费内存，而且 Linux AIO(异步磁盘IO) 也要求使用directio的形式。</p>
<h3 id="proxy-request-buffering"><a href="#proxy-request-buffering" class="headerlink" title="proxy_request_buffering"></a>proxy_request_buffering</h3><p>控制处理客户端包体的行为，如果设置为 on, 则 nginx 会接收完 client 的整个包体后处理。如 nginx 作为反向代理服务处理客户端的上传操作，则先接收完包体再转发给上游，这样上游异常的时候，nginx 可以多次重试上传，但有个问题是如果包体过大，nginx 端如果负载较重话，会有大量的写磁盘操作，同时对磁盘的容量也有较高要求。如果设置为 off, 则传输变成流式处理，一个 chunk 一个 chunk<br>传输，传输出错更多需要 client 端重试。</p>
<h3 id="proxy-buffer-size"><a href="#proxy-buffer-size" class="headerlink" title="proxy_buffer_size"></a>proxy_buffer_size</h3><blockquote>
<p>Sets the size of the buffer used for reading the first part of the response received from the proxied server. This part usually contains a small response header. By default, the buffer size is equal to one memory page. This is either 4K or 8K, depending on a platform.</p>
</blockquote>
<h3 id="proxy-buffers"><a href="#proxy-buffers" class="headerlink" title="proxy_buffers"></a>proxy_buffers</h3><blockquote>
<p>Sets the number and size of the buffers used for reading a response from the proxied server, for a single connection. By default, the buffer size is equal to one memory page. This is either 4K or 8K, depending on a platform.</p>
</blockquote>
<h3 id="proxy-buffering"><a href="#proxy-buffering" class="headerlink" title="proxy_buffering"></a>proxy_buffering</h3><blockquote>
<p>Enables or disables buffering of responses from the proxied server.</p>
<p>When buffering is enabled, nginx receives a response from the proxied server as soon as possible, saving it into the buffers set by the proxy_buffer_size and proxy_buffers directives. If the whole response does not fit into memory, a part of it can be saved to a temporary file on the disk. Writing to temporary files is controlled by the proxy_max_temp_file_size and proxy_temp_file_write_size directives.</p>
<p>When buffering is disabled, the response is passed to a client synchronously, immediately as it is received. nginx will not try to read the whole response from the proxied server. The maximum size of the data that nginx can receive from the server at a time is set by the proxy_buffer_size directive.</p>
</blockquote>
<p>当 <code>proxy_buffering on</code> 时处理上游的响应可以使用 <code>proxy_buffer_size</code> 和 <code>proxy_buffers</code> 两个缓冲区；而设置 <code>proxy_buffering off</code> 时，只能使用<code>proxy_buffer_size</code> 一个缓冲区。</p>
<h3 id="proxy-busy-size"><a href="#proxy-busy-size" class="headerlink" title="proxy_busy_size"></a>proxy_busy_size</h3><blockquote>
<p>When buffering of responses from the proxied server is enabled, limits the total size of buffers that can be busy sending a response to the client while the response is not yet fully read. In the meantime, the rest of the buffers can be used for reading the response and, if needed, buffering part of the response to a temporary file. By default, size is limited by the size of two buffers set by the proxy_buffer_size and proxy_buffers directives.</p>
</blockquote>
<p>当接收上游的响应发送给 client 端时，也需要一个缓存区，即发送给客户端而未确认的部分，这个 buffer 也是从 proxy_buffers 中分配，该指令限定能从 proxy_buffers 中分配的大小。</p>
<h3 id="keepalive"><a href="#keepalive" class="headerlink" title="keepalive"></a>keepalive</h3><p>该指令可作用于 nginx.conf 和 upstream 的 server 中；当作用于 nginx.conf 中时，表示作为 http server 端回复客户端响应后，不关闭该连接，让该连接保持 <code>ESTAB</code> 状态，即 keepalive。 当该指令作用于 upstrem 块中时，表示发送给上游的 http 请求加入 <code>connection: keepalive</code>, 让服务端保活该连接。值得注意的是服务端和客户端均需要设置 keepalive 才能实现长连接。 同时 <code>keepalive</code>指令需要和 如下两个指令配合使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keepalive_requests 100;</span><br><span class="line">keepalive_timeout 65;</span><br></pre></td></tr></table></figure>
<p>keepalive_requests 表示一个长连接可以复用的次数，keepalive_timeout 表示长连接在空闲多久后可以关闭。<br>keepalive_timeout 如果设置过大会造成 nginx 服务端 <code>ESTAB</code> 状态的连接数增多。</p>
<h2 id="nginx-维护与更新"><a href="#nginx-维护与更新" class="headerlink" title="nginx 维护与更新  "></a>nginx 维护与更新  <span id="anchor9"></span></h2><p>nginx 信号集和 nginx 操作之间的对应关系如下：</p>
<table>
<thead>
<tr>
<th>nginx operation</th>
<th>signal</th>
</tr>
</thead>
<tbody>
<tr>
<td>reload</td>
<td>SIGHUP</td>
</tr>
<tr>
<td>reload</td>
<td>SIGUSR1</td>
</tr>
<tr>
<td>stop</td>
<td>SIGTERM</td>
</tr>
<tr>
<td>quit</td>
<td>SIGQUIT</td>
</tr>
<tr>
<td>hot update</td>
<td>SIGUSR2 &amp; SIGWINCH &amp; SIGQUIT</td>
</tr>
</tbody>
</table>
<h3 id="stop-vs-quit"><a href="#stop-vs-quit" class="headerlink" title="stop vs quit"></a>stop vs quit</h3><p>stop 发送 SIGTERM 信号，表示要求强制退出，quit 发送 SIGQUIT，表示优雅地退出。 具体区别在于，worker 进程在收到 SIGQUIT 消息(注意不是直接发送信号，所以这里用消息替代)后，会关闭监听的套接字，关闭当前空闲的连接(可以被抢占的连接)，然后提前处理所有的定时器事件，最后退出。没有特殊情况，都应该使用 quit 而不是 stop。</p>
<h3 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h3><p>master 进程收到 SIGHUP 后，会重新进行配置文件解析、共享内存申请，等一系列其他的工作，然后产生一批新的 worker 进程，最后向旧的 worker 进程发送 SIGQUIT 对应的消息，最终无缝实现了重启操作。 再 master 进程重新解析配置文件过程中，如果解析失败则会回滚使用原来的配置文件，即 reload 失败，此时工作的还是老的 worker。</p>
<h3 id="reopen"><a href="#reopen" class="headerlink" title="reopen"></a>reopen</h3><p>master 进程收到 SIGUSR1 后，会重新打开所有已经打开的文件(比如日志)，然后向每个 worker 进程发送 SIGUSR1 信息，worker 进程收到信号后，会执行同样的操作。reopen 可用于日志切割，比如 nginx 官方就提供了一个方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mv access.log access.log.0</span><br><span class="line">$ kill -USR1 `cat master.nginx.pid`</span><br><span class="line">$ sleep 1</span><br><span class="line">$ gzip access.log.0    # do something with access.log.0</span><br></pre></td></tr></table></figure>
<p>这里 sleep 1 是必须的，因为在 master 进程向 worker 进程发送 SIGUSR1 消息到 worker 进程真正重新打开 access.log 之间，有一段时间窗口，此时 worker 进程还是向文件 access.log.0 里写入日志的。通过 sleep 1s，保证了 access.log.0 日志信息的完整性(如果没有 sleep 而直接进行压缩，很有可能出现日志丢失的情况)。</p>
<h3 id="hot-update"><a href="#hot-update" class="headerlink" title="hot update"></a>hot update</h3><p>某些时候我们需要进行二进制热更新，nginx 在设计的时候就包含了这种功能，不过无法通过 nginx 提供的命令行完成，我们需要手动发送信号。</p>
<p>首先需要给当前的 master 进程发送 SIGUSR2，之后 master 会重命名 nginx.pid 到 nginx.pid.oldbin，然后 fork 一个新的进程，新进程会通过 execve 这个系统调用，使用新的 nginx ELF 文件替换当前的进程映像，成为新的 master 进程。新 master 进程起来之后，就会进行配置文件解析等操作，然后 fork 出新的 worker 进程开始工作。</p>
<p>接着我们向旧的 master 发送 SIGWINCH 信号，然后旧的 master 进程则会向它的 worker 进程发送 SIGQUIT 信息，从而使得 worker 进程退出。向 master 进程发送 SIGWINCH 和 SIGQUIT 都会使得 worker 进程退出，但是前者不会使得 master 进程也退出。</p>
<p>最后，如果我们觉得旧的 master 进程使命完成，就可以向它发送 SIGQUIT 信号，让其退出了。</p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><ul>
<li><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/lua/main.html" target="_blank" rel="noopener">OpenResty 最佳实践</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module/blob/master/README.markdown" target="_blank" rel="noopener">lua-nginx-module Readme</a></li>
<li><a href="http://nginx.org/en/docs/" target="_blank" rel="noopener">nginx doc</a></li>
<li><a href="https://cdn2.jianshu.io/p/0a4bc3231643" target="_blank" rel="noopener">lua 与 c 进行交互</a></li>
<li><a href="http://io.upyun.com/2017/08/19/nginx-signals/" target="_blank" rel="noopener">浅谈 nginx 信号集</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/linux-system-profile-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/linux-system-profile-command/" itemprop="url">
                  Linux 系统优化指令杂记
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-24 11:14:44" itemprop="dateCreated datePublished" datetime="2018-09-24T11:14:44+08:00">2018-09-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-10-05 14:39:10" itemprop="dateModified" datetime="2018-10-05T14:39:10+08:00">2018-10-05</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/24/linux-system-profile-command/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/24/linux-system-profile-command/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/24/linux-system-profile-command/" class="leancloud_visitors" data-flag-title="Linux 系统优化指令杂记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="系统优化的前-5-分钟"><a href="#系统优化的前-5-分钟" class="headerlink" title="系统优化的前 5 分钟"></a>系统优化的前 5 分钟</h2><p><a href="https://medium.com/netflix-techblog/linux-performance-analysis-in-60-000-milliseconds-accc10403c55" target="_blank" rel="noopener">使用如下指令了解机器的整体运行情况</a>, <a href="https://segmentfault.com/a/1190000004104493" target="_blank" rel="noopener">此处有指令的中文解释</a></p>
<ul>
<li><code>uptime</code> 检查系统是否宕机重启</li>
<li><code>dmesg | tail</code>  查看 dmesg 是否有系统层面错误日志</li>
<li><code>vmstat 1</code> 检查 cpu 的负载情况, 是否存在 cpu 饱和</li>
<li><code>mpstat -P ALL 1</code> 检查CPU是否存在负载不均衡; 单个过于忙碌的CPU可能意味着整个应用只有单个线程在工作</li>
<li><code>pidstat 1</code> 观察随时间变化的 cpu、内存等信息</li>
<li><code>iostat -xz 1</code> 弄清块设备（磁盘）的状况, 包括工作负载和处理性能</li>
<li><code>free -m</code> 查看剩余内存, 文件和 IO 缓存大小</li>
<li><code>sar -n DEV 1</code> 检查网络流量的工作负载：rxkB/s和txkB/s, 以及它是否达到限额了</li>
<li><code>sar -n TCP,ETCP 1</code> 查看系统网络负载, 过多重传可能是服务器过载开始丢包了</li>
<li><code>top</code> 没什么好多, 大家都会用的</li>
</ul>
<h2 id="top-各个指标含义"><a href="#top-各个指标含义" class="headerlink" title="top 各个指标含义"></a>top 各个指标含义</h2><ul>
<li>Cpu(s)：表示这一行显示CPU总体信息</li>
<li>0.0%us：用户态进程占用CPU时间百分比, 不包含renice值为负的任务占用的CPU的时间。</li>
<li>0.7%sy：内核占用CPU时间百分比</li>
<li>0.0%ni：改变过优先级的进程占用CPU的百分比</li>
<li>99.3%id：空闲CPU时间百分比</li>
<li>0.0%wa：等待I/O的CPU时间百分比</li>
<li>0.0%hi： CPU硬中断时间百分比</li>
<li>0.0%si： CPU软中断时间百分比</li>
<li>0.0%st:  超线程开启时候, 线程等待另外一个虚拟核完成任务的时间百分比</li>
</ul>
<blockquote>
<p>note：这里显示数据是所有cpu的平均值, 如果想看每一个cpu的处理情况, 按1即可；折叠, 再次按1</p>
</blockquote>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/24/linux-system-profile-command/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/linux-command-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/linux-command-note/" itemprop="url">
                  linux 命令助记
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-24 11:02:31" itemprop="dateCreated datePublished" datetime="2018-09-24T11:02:31+08:00">2018-09-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-10-05 16:17:04" itemprop="dateModified" datetime="2018-10-05T16:17:04+08:00">2018-10-05</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/24/linux-command-note/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/24/linux-command-note/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/24/linux-command-note/" class="leancloud_visitors" data-flag-title="linux 命令助记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="print-all-system-information"><a href="#print-all-system-information" class="headerlink" title="print all system information"></a>print all system information</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>
<h3 id="kernel-version"><a href="#kernel-version" class="headerlink" title="kernel version:"></a>kernel version:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure>
<h3 id="see-hardware-info"><a href="#see-hardware-info" class="headerlink" title="see hardware info."></a>see hardware info.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/meminfo cat /proc/cpuinfo</span><br></pre></td></tr></table></figure>
<h3 id="count-line"><a href="#count-line" class="headerlink" title="count line"></a>count line</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name &apos;\*.c&apos; | xargs wc -l &#123;&#125;\;</span><br></pre></td></tr></table></figure>
<h3 id="yum-remove-without-dependency"><a href="#yum-remove-without-dependency" class="headerlink" title="yum remove without dependency"></a>yum remove without dependency</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -e --nodeps vim-common-7.4.160-1.el7.x86_64</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/24/linux-command-note/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/updns-qps-tracing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/updns-qps-tracing/" itemprop="url">
                  updns QPS 异常问题排查
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-24 10:46:32 / 修改时间：10:51:22" itemprop="dateCreated datePublished" datetime="2018-09-24T10:46:32+08:00">2018-09-24</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/24/updns-qps-tracing/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/24/updns-qps-tracing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/24/updns-qps-tracing/" class="leancloud_visitors" data-flag-title="updns QPS 异常问题排查">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境问题排查"><a href="#环境问题排查" class="headerlink" title="环境问题排查"></a>环境问题排查</h2><ul>
<li>系统: 系统版本, 内核版本</li>
<li>cpu: 物理核心数, 物理核数,逻辑核数</li>
<li>内存: 内存大小</li>
<li>网卡: 网卡是否是万兆, 驱动型号</li>
</ul>
<h2 id="updns-版本确认（排查是否最近代码导致）"><a href="#updns-版本确认（排查是否最近代码导致）" class="headerlink" title="updns 版本确认（排查是否最近代码导致）"></a>updns 版本确认（排查是否最近代码导致）</h2><ul>
<li>以前压测过的版本回退 v0.03</li>
<li>使用最近版本测试</li>
</ul>
<h2 id="系统各种参数优化确认"><a href="#系统各种参数优化确认" class="headerlink" title="系统各种参数优化确认"></a>系统各种参数优化确认</h2><ul>
<li>sendmmsg recvmmsg</li>
<li>多线程发包</li>
<li>so_reuseport</li>
<li>绑定网卡亲缘性</li>
<li>系统参数调优化</li>
<li>查看软件终端, 查看 cpu 绑定是否生效</li>
</ul>
<h2 id="使用系统工具确认压测机器是否正常"><a href="#使用系统工具确认压测机器是否正常" class="headerlink" title="使用系统工具确认压测机器是否正常"></a>使用系统工具确认压测机器是否正常</h2><ul>
<li>iperf 网络ok, 吞吐量OK, QPS: 60s  400W QPS, 800Mb/s</li>
<li>udp sender 查看发包 80w/s, 系统占用低</li>
<li>perf spin_irq_lock 60%</li>
<li>查看网卡的收包, 接包, 丢包情况</li>
</ul>
<h2 id="被测端和压测端的情况"><a href="#被测端和压测端的情况" class="headerlink" title="被测端和压测端的情况"></a>被测端和压测端的情况</h2>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/nginx-server-locaton-re-match/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/nginx-server-locaton-re-match/" itemprop="url">
                  nginx server locaton 匹配顺序
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-24 10:40:52 / 修改时间：10:44:57" itemprop="dateCreated datePublished" datetime="2018-09-24T10:40:52+08:00">2018-09-24</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/24/nginx-server-locaton-re-match/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/24/nginx-server-locaton-re-match/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/24/nginx-server-locaton-re-match/" class="leancloud_visitors" data-flag-title="nginx server locaton 匹配顺序">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="server-name"><a href="#server-name" class="headerlink" title="server name"></a>server name</h2><ol>
<li>完全匹配</li>
<li>通配符在前面，<code>*.tesetwb.com</code></li>
<li>通配符在后面，<code>www.testwb.*</code></li>
<li>正则表达式匹配 <code>(.*)?anyfeel.cn</code></li>
</ol>
<h2 id="location"><a href="#location" class="headerlink" title="location"></a>location</h2><ol>
<li>完全匹配，<code>=</code> or <code>/</code></li>
<li>大小写敏感，<code>~</code></li>
<li>大小写不敏感，<code>~*</code></li>
<li>前半部分匹配，<code>^~</code></li>
<li>@location, 表示只能用于 nginx 内部跳转</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/nginx-module-init/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/nginx-module-init/" itemprop="url">
                  Nginx 模块初始化过程
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-24 09:50:39" itemprop="dateCreated datePublished" datetime="2018-09-24T09:50:39+08:00">2018-09-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-10-05 16:17:27" itemprop="dateModified" datetime="2018-10-05T16:17:27+08:00">2018-10-05</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/24/nginx-module-init/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/24/nginx-module-init/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/24/nginx-module-init/" class="leancloud_visitors" data-flag-title="Nginx 模块初始化过程">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="初始化核心函数"><a href="#初始化核心函数" class="headerlink" title="初始化核心函数"></a>初始化核心函数</h2><p><code>ngx_init_cycle()(ngx_cycle.c:275)</code> -&gt; <code>ngx_conf_parse()(ngx_conf_file.c:)</code> -&gt; <code>ngx_conf_handler()</code></p>
<h2 id="初始化步骤"><a href="#初始化步骤" class="headerlink" title="初始化步骤"></a>初始化步骤</h2><ul>
<li>modules 和序号绑定关系<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ngx_int_t</span><br><span class="line">ngx_preinit_modules(void)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_uint_t  i;</span><br><span class="line"></span><br><span class="line">    for (i = 0; ngx_modules[i]; i++) &#123;</span><br><span class="line">        ngx_modules[i]-&gt;index = i;</span><br><span class="line">        ngx_modules[i]-&gt;name = ngx_module_names[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_modules_n = i;</span><br><span class="line">    ngx_max_module = ngx_modules_n + NGX_MAX_DYNAMIC_MODULES;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/24/nginx-module-init/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/tcp-connection-status/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/tcp-connection-status/" itemprop="url">
                  TCP 连接状态整理
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-24 09:41:42" itemprop="dateCreated datePublished" datetime="2018-09-24T09:41:42+08:00">2018-09-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-10-05 16:16:11" itemprop="dateModified" datetime="2018-10-05T16:16:11+08:00">2018-10-05</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/24/tcp-connection-status/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/24/tcp-connection-status/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/24/tcp-connection-status/" class="leancloud_visitors" data-flag-title="TCP 连接状态整理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h2><ol>
<li>五层架构与七层架构</li>
<li>链路层作用 ARP，以太网包格式</li>
<li>IP/TCP 格式</li>
<li>TCP 状态机及常用的错误码，time_wait 相关系，SO_RESUSEADDR 作用。</li>
<li>NAGEL 算法(TCP_NODELAY关闭NAGEL)滑动窗口拥塞避免（慢启动），快速重传与快速恢复，选择重传</li>
<li>四种定时器的作用 ACK 定时器，persist 定时器，keep-alive 定时器，2MSL 定时器</li>
<li>使用 TCPDUMP 和应用程序分析 TCP 状态机</li>
</ol>
<blockquote>
<p>note:so_linger 作用： 发送 RST 包来断开连接，而不是发送 FIN.</p>
</blockquote>
<h2 id="connect-resty-by-peer"><a href="#connect-resty-by-peer" class="headerlink" title="connect resty by peer"></a>connect resty by peer</h2><h3 id="含义"><a href="#含义" class="headerlink" title="含义"></a>含义</h3><p>本端向对端发送数据，但对端无法识别该连接，返回一个 RST 强制关闭连接</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/24/tcp-connection-status/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/23/adjust-disk-partition-size/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/23/adjust-disk-partition-size/" itemprop="url">
                  Linux 磁盘调整
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-23 21:19:50 / 修改时间：21:27:49" itemprop="dateCreated datePublished" datetime="2018-09-23T21:19:50+08:00">2018-09-23</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/23/adjust-disk-partition-size/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/23/adjust-disk-partition-size/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/23/adjust-disk-partition-size/" class="leancloud_visitors" data-flag-title="Linux 磁盘调整">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="磁盘工具"><a href="#磁盘工具" class="headerlink" title="磁盘工具"></a>磁盘工具</h3><ul>
<li>parted/fdisk/gdisk/ blkid</li>
</ul>
<p>note:</p>
<ul>
<li>注意区分 PARTUUID 和 UUID</li>
<li>gdisk sort 可以调整分区序号</li>
</ul>
<h3 id="磁盘格式化"><a href="#磁盘格式化" class="headerlink" title="磁盘格式化"></a>磁盘格式化</h3><ul>
<li>EFI 分区格式化<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.fat -F32 /dev/sdxY -&gt; EFI 分区格式化</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果没有 mkfs.fat 则安装 dosfstools</p>
<ul>
<li>分区格式化<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/sda1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="磁盘启动管理"><a href="#磁盘启动管理" class="headerlink" title="磁盘启动管理"></a>磁盘启动管理</h3><ul>
<li><p>安装 bootctl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootctl —path=/mnt/boot install</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加磁盘启动选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/boot/loader/entries/arch.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里写入的是 root 分区的 PARTUUID</p>
<h3 id="磁盘分区大小调整-resize"><a href="#磁盘分区大小调整-resize" class="headerlink" title="磁盘分区大小调整(resize)"></a>磁盘分区大小调整(resize)</h3><ul>
<li>先删除原有分区，然后再重新建立（启动区块号不能变，否则会丢失数据）</li>
<li>使用 resize2fs /dev/sda1 来重新调整分区大小</li>
<li>最后需要解决  EFI loader 中 PARTUUID，PARTUUID 可能会有变更</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/23/deploy-python-program-by-pyenv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/23/deploy-python-program-by-pyenv/" itemprop="url">
                  使用 pyenv 构建线上 python 环境
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-23 18:34:44 / 修改时间：19:25:56" itemprop="dateCreated datePublished" datetime="2018-09-23T18:34:44+08:00">2018-09-23</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/23/deploy-python-program-by-pyenv/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/23/deploy-python-program-by-pyenv/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/23/deploy-python-program-by-pyenv/" class="leancloud_visitors" data-flag-title="使用 pyenv 构建线上 python 环境">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用-pyenv-部署-python-线上环境"><a href="#使用-pyenv-部署-python-线上环境" class="headerlink" title="使用 pyenv 部署 python 线上环境"></a>使用 pyenv 部署 python 线上环境</h2><p>当生产服务器因权限问题或者系统版本阉割出现 python 依赖问题时，可以使用 <a href="https://github.com/yyuu/pyenv" target="_blank" rel="noopener">pyenv</a></p>
<h2 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h2><ol>
<li><p>下载 pyenv.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/yyuu/pyenv.git ~/.pyenv</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置<code>PYENV_ROOT</code> 为 <code>pyenv</code> 安装路径, 添加 <code>$PYENV_ROOT/bin</code> 至环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo &apos;export PYENV_ROOT=&quot;$HOME/.pyenv&quot;&apos; &gt;&gt; ~/.bash_profile</span><br><span class="line">$ echo &apos;export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;&apos; &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启 <code>pyenv</code> <code>shims</code> 和自动补全</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &apos;eval &quot;$(pyenv init -)&quot;&apos; &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 shell 让 <code>pyenv</code> 生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ exec $SHELL</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装需要的 python 版本 至 $PYENV_ROOT/versions 目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pyenv install 2.7.8</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="pyenv-常用命令"><a href="#pyenv-常用命令" class="headerlink" title="pyenv 常用命令"></a>pyenv 常用命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pyenv install 2.7.5</span><br><span class="line">pyenv versions</span><br><span class="line">pyenv version</span><br><span class="line">pyenv local 2.7.5</span><br><span class="line">pyenv shell 2.7.5</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="anyfeel" />
            
              <p class="site-author-name" itemprop="name">anyfeel</p>
              <p class="site-description motion-element" itemprop="description">我就是我，是颜色不一样的烟花</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">anyfeel</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Pisces</a> v6.4.2</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  

  
    <script id="dsq-count-scr" src="https://anyfeel-cn.disqus.com/count.js" async></script>
  

  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function showTime(Counter) {
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url: { "$in": entries } }) })
        .done(function ({ results }) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function ({ responseJSON }) {
          console.log("LeanCloud Counter Error: " + responseJSON.code + " " + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "inBlnKMv1VjHkaivHEP16QIR-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "inBlnKMv1VjHkaivHEP16QIR-gzGzoHsz",
                'X-LC-Key': "SNgeOmE0kLNPw2H5Iv2BitUs",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          if ($('.post-title-link').length >= 1) {
            showTime(Counter);
          }
          
        })
    });
  </script>



  

  

  

  
  

  

  

  

  

  

</body>
</html>
