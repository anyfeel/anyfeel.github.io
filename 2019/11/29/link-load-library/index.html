<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.2',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="引子过度优化 - volatile 编译器优化 12345x= 0Thread1            Thread2lock();            lock;x++;               x++;unlock();          unlock(); 变量缓存在寄存器而不写回  cpu 动态调度换序 1234x = y = 0;Thread1           Thread2x">
<meta name="keywords" content="linux">
<meta property="og:type" content="article">
<meta property="og:title" content="link-load-library">
<meta property="og:url" content="http://yoursite.com/2019/11/29/link-load-library/index.html">
<meta property="og:site_name" content="冰澜">
<meta property="og:description" content="引子过度优化 - volatile 编译器优化 12345x= 0Thread1            Thread2lock();            lock;x++;               x++;unlock();          unlock(); 变量缓存在寄存器而不写回  cpu 动态调度换序 1234x = y = 0;Thread1           Thread2x">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/memory.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/memory-maping1.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/语法树.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/语义分析.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/section-merge.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/got.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/got-plt.png">
<meta property="og:image" content="http://onepiece.nos-eastchina1.126.net/markdown/interrupt1.png">
<meta property="og:updated_time" content="2019-11-29T15:21:40.502Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="link-load-library">
<meta name="twitter:description" content="引子过度优化 - volatile 编译器优化 12345x= 0Thread1            Thread2lock();            lock;x++;               x++;unlock();          unlock(); 变量缓存在寄存器而不写回  cpu 动态调度换序 1234x = y = 0;Thread1           Thread2x">
<meta name="twitter:image" content="http://onepiece.nos-eastchina1.126.net/markdown/memory.png">






  <link rel="canonical" href="http://yoursite.com/2019/11/29/link-load-library/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>link-load-library | 冰澜</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冰澜</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/29/link-load-library/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="anyfeel">
      <meta itemprop="description" content="我就是我，是颜色不一样的烟花">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冰澜">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">link-load-library
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-29 23:09:52 / 修改时间：23:21:40" itemprop="dateCreated datePublished" datetime="2019-11-29T23:09:52+08:00">2019-11-29</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/29/link-load-library/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/29/link-load-library/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/11/29/link-load-library/" class="leancloud_visitors" data-flag-title="link-load-library">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><h2 id="过度优化-volatile"><a href="#过度优化-volatile" class="headerlink" title="过度优化 - volatile"></a>过度优化 - volatile</h2><ul>
<li><p>编译器优化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x= <span class="number">0</span></span><br><span class="line">Thread1            Thread2</span><br><span class="line">lock();            lock;</span><br><span class="line">x++;               x++;</span><br><span class="line">unlock();          unlock();</span><br></pre></td></tr></table></figure>
<p>变量缓存在寄存器而不写回</p>
</li>
<li><p>cpu 动态调度换序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = y = <span class="number">0</span>;</span><br><span class="line">Thread1           Thread2</span><br><span class="line">x= <span class="number">1</span>;             y = <span class="number">1</span>;</span><br><span class="line">r1 = y;           r2 = x;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = y = <span class="number">0</span>;</span><br><span class="line">Thread1           Thread2</span><br><span class="line">r1 = y;           y = <span class="number">1</span>;</span><br><span class="line">x1 = <span class="number">1</span>;           r2 = x;</span><br></pre></td></tr></table></figure>
<p>编译器指令顺序交换</p>
</li>
</ul>
<hr>
<h2 id="过度优化-barrier"><a href="#过度优化-barrier" class="headerlink" title="过度优化 - barrier"></a>过度优化 - barrier</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> T* pInst = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">T* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pInst == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        lock();</span><br><span class="line">        <span class="keyword">if</span> (pInst == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pInst == <span class="keyword">new</span> T;</span><br><span class="line">        &#125;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pInst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++ 的 new 对象是分 2 个步骤:</p>
<ul>
<li>分配内存</li>
<li>调用构造函数</li>
</ul>
<p>pInst = new T 包含了 3 个步骤:</p>
<ul>
<li>分配内存</li>
<li>在分配内存上调用构造函数</li>
<li>将内存地址复制给 pInst</li>
</ul>
<p>而步骤 2 和步骤 3 是可以交换的，导致的问题是分配的内存尚未调用构造函数就已经被分配出去</p>
<hr>
<p>使用 <code>lwsync</code> 指令，防止编译指令换序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> barrier() __asm__ volatile (<span class="meta-string">"lwsync"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> T* pInst = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">T* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pInst != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        lock();</span><br><span class="line">        <span class="keyword">if</span> (pInst != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            T* temp = <span class="keyword">new</span> T;</span><br><span class="line">            barrier();</span><br><span class="line">            pInst == temp;</span><br><span class="line">        &#125;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pInst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="内存与装载"><a href="#内存与装载" class="headerlink" title="内存与装载"></a>内存与装载</h1><p>64 位内核虚拟地址和程序布局空间关系</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/memory.png" alt=":scale 100%"></p>
<hr>
<p>可执行文件，虚拟地址空间和物理地址空间的映射关系</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/memory-maping1.png" alt=":scale 100%"></p>
<hr>
<h2 id="进程堆管理"><a href="#进程堆管理" class="headerlink" title="进程堆管理"></a>进程堆管理</h2><p>两种堆分配形式</p>
<ul>
<li>brk 系统调用，设置进程数据段的结束地址，向高地址移动，扩大的部分空间可以被程序使用（sbrk 对 brk 的包装）</li>
<li>mmap 向操作系统申请一段虚拟地址空间，可以映射到某个文件，不映射文件时为匿名空间（用于 malloc)</li>
</ul>
<h2 id="调用惯例"><a href="#调用惯例" class="headerlink" title="调用惯例"></a>调用惯例</h2><p>函数调用方和被调用的约定</p>
<ul>
<li>函数参数的传递顺序和方式（栈传递，寄存器传递；压栈顺序（左到右，右到左））</li>
<li>栈的维护方式，出栈由调用方还是被调用方</li>
<li>名字修饰策略</li>
</ul>
<table>
<thead>
<tr>
<th>调用惯例</th>
<th>出栈方</th>
<th>参数传递</th>
<th>名字修饰</th>
</tr>
</thead>
<tbody>
<tr>
<td>cdecl</td>
<td>函数调用方</td>
<td>从右至左</td>
<td>下划线+函数名</td>
</tr>
<tr>
<td>stdcall</td>
<td>函数本身</td>
<td>从右至左压栈</td>
<td>下划线+函数名+@+参数字节数，如 int func(int a, double b) -&gt; _func@12</td>
</tr>
<tr>
<td>fastcall</td>
<td>函数本身</td>
<td>头两个字节放入寄存器，其他从右至左压栈</td>
<td>@+函数名+@+参数字节数</td>
</tr>
<tr>
<td>pascal</td>
<td>函数本身</td>
<td>从左至右压入栈</td>
<td>较复杂</td>
</tr>
</tbody>
</table>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><ul>
<li>预编译</li>
<li>编译</li>
<li>汇编</li>
<li>链接</li>
</ul>
<h2 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h2><p>预编译工作:宏展开，删除注释，生成行号和文件标识</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hellow world!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~ gcc -E hello.c -o hello.i</span><br><span class="line">~ cat hello.i</span><br><span class="line">...</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span># <span class="number">840</span> <span class="string">"/usr/include/stdio.h"</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">extern void flockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__));</span><br><span class="line">extern int ftrylockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__)) ;</span><br><span class="line">extern void funlockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__));</span><br><span class="line"># <span class="number">868</span> <span class="string">"/usr/include/stdio.h"</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">2</span> <span class="string">"hello.c"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">3</span> <span class="string">"hello.c"</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hellow world!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h2><ul>
<li>词法分析</li>
<li>语法分析</li>
<li>语义分析</li>
</ul>
<h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array[index] = (index + 4) * (2 + 6)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>symbol</strong></td>
<td style="text-align:center">array</td>
<td style="text-align:center">[</td>
<td style="text-align:center">index</td>
<td style="text-align:center">]</td>
<td style="text-align:center">=</td>
<td style="text-align:center">（</td>
<td style="text-align:center">index</td>
<td style="text-align:center">+</td>
<td style="text-align:center">4</td>
<td style="text-align:center">）</td>
<td style="text-align:center">*</td>
<td style="text-align:center">（</td>
<td style="text-align:center">2</td>
<td style="text-align:center">+</td>
<td style="text-align:center">6</td>
<td style="text-align:center">）</td>
</tr>
<tr>
<td style="text-align:center"><strong>type</strong></td>
<td style="text-align:center">标识符</td>
<td style="text-align:center">左方括号</td>
<td style="text-align:center">标识符</td>
<td style="text-align:center">右方括号</td>
<td style="text-align:center">赋值</td>
<td style="text-align:center">左圆括号</td>
<td style="text-align:center">标识符</td>
<td style="text-align:center">加号</td>
<td style="text-align:center">数字</td>
<td style="text-align:center">右圆括号</td>
<td style="text-align:center">乘号</td>
<td style="text-align:center">左圆括号</td>
<td style="text-align:center">数字</td>
<td style="text-align:center">加号</td>
<td style="text-align:center">数字</td>
<td style="text-align:center">右圆括号</td>
</tr>
</tbody>
</table>
<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p><img src="http://onepiece.nos-eastchina1.126.net/markdown/语法树.png" alt=":scale 100%"></p>
<hr>
<h3 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h3><p><img src="http://onepiece.nos-eastchina1.126.net/markdown/语义分析.png" alt=":scale 100%"></p>
<hr>
<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><p>汇编代码转换成机器指令(可理解为 2 进制)</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p>目标文件链接成可执行文件</p>
<ul>
<li>地址和空间分配 - Address and Storage Allocation</li>
<li>符号决议 - Symbol Resolution</li>
<li>重定位 - Relocation</li>
</ul>
<hr>
<h1 id="目标文件"><a href="#目标文件" class="headerlink" title="目标文件"></a>目标文件</h1><h2 id="目标文件类型"><a href="#目标文件类型" class="headerlink" title="目标文件类型"></a>目标文件类型</h2><table>
<thead>
<tr>
<th style="text-align:left">目标文件类型</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Relocatable File</td>
<td style="text-align:left">包含代码和数据，可链接为可执行文件或者共享目标文件，静态文件也属于这一类</td>
<td style="text-align:left">*.o</td>
</tr>
<tr>
<td style="text-align:left">Executable File</td>
<td style="text-align:left">可执行文件</td>
<td style="text-align:left">/bin/bash</td>
</tr>
<tr>
<td style="text-align:left">Shared Object File</td>
<td style="text-align:left">可以和其他重新可定位文件链接成新的共享文件；作为运行进程的映象一部分</td>
<td style="text-align:left">*.so</td>
</tr>
<tr>
<td style="text-align:left">Core Dump File</td>
<td style="text-align:left">进程意外终止是的堆栈信息</td>
<td style="text-align:left">core dump</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="目标内容"><a href="#目标内容" class="headerlink" title="目标内容"></a>目标内容</h2><p>示例代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int printf(const char* format, ...);</span><br><span class="line"></span><br><span class="line">int global_init_var = 84;</span><br><span class="line">int global_uniit_var;</span><br><span class="line"></span><br><span class="line">void func1(int i) &#123;</span><br><span class="line">    printf(&quot;%d\n&quot;, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line">    static int static_var = 85;</span><br><span class="line">    static int static_var2;</span><br><span class="line"></span><br><span class="line">    int a = 1;</span><br><span class="line">    int b;</span><br><span class="line">    func1(static_var + static_var2 + a + b);</span><br><span class="line"></span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看示例代码的 <code>Sections</code> 情况，因为还是目标文件，<code>VMA</code> 和 <code>LMA</code> 地址都是 0，需要在链接的时候确定，objdump 目标文件的一些常见 <code>Section</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -w -h SimpleSection.o</span><br><span class="line"></span><br><span class="line">SimpleSection.o:     file format elf64-x86-<span class="number">64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name            Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  <span class="number">0</span> .text           <span class="number">00000057</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">00000040</span>  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  <span class="number">1</span> .data           <span class="number">00000008</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">00000098</span>  <span class="number">2</span>**<span class="number">2</span>  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  <span class="number">2</span> .bss            <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a0  <span class="number">2</span>**<span class="number">2</span>  ALLOC</span><br><span class="line">  <span class="number">3</span> .rodata         <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a0  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  <span class="number">4</span> .comment        <span class="number">00000012</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a4  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, READONLY</span><br><span class="line">  <span class="number">5</span> .note.GNU-stack <span class="number">00000000</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>b6  <span class="number">2</span>**<span class="number">0</span>  CONTENTS, READONLY</span><br><span class="line">  <span class="number">6</span> .eh_frame       <span class="number">00000058</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>b8  <span class="number">2</span>**<span class="number">3</span>  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br></pre></td></tr></table></figure>
<p><em>Sections</em> 常见字段含义</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">.text</td>
<td style="text-align:left">代码段</td>
</tr>
<tr>
<td style="text-align:left">.data</td>
<td style="text-align:left">数据段</td>
</tr>
<tr>
<td style="text-align:left">.bss</td>
<td style="text-align:left">未初始化的全局变量和静态变量</td>
</tr>
<tr>
<td style="text-align:left">.rodata</td>
<td style="text-align:left">只读数据段（只读字符串等， eg:  “hello %s”)</td>
</tr>
<tr>
<td style="text-align:left">.comment</td>
<td style="text-align:left">编译器版本信息</td>
</tr>
<tr>
<td style="text-align:left">.note.GNU-stack</td>
<td style="text-align:left">堆栈提示段</td>
</tr>
<tr>
<td style="text-align:left">.eh_frame</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="目标文件段分布"><a href="#目标文件段分布" class="headerlink" title="目标文件段分布"></a>目标文件段分布</h2><p>使用 <code>readelf</code> 查看目标文件中的所有 <code>Section</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vagrant@onepiece:~/tmp   readelf -S SimpleSection.o</span><br><span class="line">There are <span class="number">13</span> section headers, starting at offset <span class="number">0x438</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type     Address           Offset   Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>     <span class="number">0000000000000000</span>  <span class="number">00000000</span> <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS <span class="number">0000000000000000</span>  <span class="number">00000040</span> <span class="number">0000000000000057</span>  <span class="number">0000000000000000</span>  AX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">3</span>] .data             PROGBITS <span class="number">0000000000000000</span>  <span class="number">00000098</span> <span class="number">0000000000000008</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .rodata           PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000</span>a0 <span class="number">0000000000000004</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .bss              NOBITS   <span class="number">0000000000000000</span>  <span class="number">000000</span>a0 <span class="number">0000000000000004</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">4</span></span><br><span class="line">  [ <span class="number">6</span>] .comment          PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000</span>a4 <span class="number">0000000000000012</span>  <span class="number">0000000000000001</span>  MS       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">7</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000b</span>6 <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">8</span>] .eh_frame         PROGBITS <span class="number">0000000000000000</span>  <span class="number">000000b</span>8 <span class="number">0000000000000058</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">8</span></span><br><span class="line">  [<span class="number">10</span>] .symtab           SYMTAB   <span class="number">0000000000000000</span>  <span class="number">00000110</span> <span class="number">0000000000000198</span>  <span class="number">0000000000000018</span>          <span class="number">11</span>    <span class="number">11</span>     <span class="number">8</span></span><br><span class="line">  [<span class="number">11</span>] .strtab           STRTAB   <span class="number">0000000000000000</span>  <span class="number">000002</span>a8 <span class="number">000000000000007b</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .rela.text        RELA     <span class="number">0000000000000000</span>  <span class="number">00000328</span> <span class="number">0000000000000078</span>  <span class="number">0000000000000018</span>   I      <span class="number">10</span>     <span class="number">1</span>     <span class="number">8</span></span><br><span class="line">  [ <span class="number">9</span>] .rela.eh_frame    RELA     <span class="number">0000000000000000</span>  <span class="number">000003</span>a0 <span class="number">0000000000000030</span>  <span class="number">0000000000000018</span>   I      <span class="number">10</span>     <span class="number">8</span>     <span class="number">8</span></span><br><span class="line">  [<span class="number">12</span>] .shstrtab         STRTAB   <span class="number">0000000000000000</span>  <span class="number">000003</span>d0 <span class="number">0000000000000061</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h1><h2 id="静态链接过程"><a href="#静态链接过程" class="headerlink" title="静态链接过程"></a>静态链接过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ gcc -c a.c</span><br><span class="line">~ gcc -c b.c</span><br><span class="line">~ ld a.o b.o -e main -o ab</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/* a.c */</span><br><span class="line">extern int shared;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int a = 100;</span><br><span class="line">    swap(&amp;a, &amp;shared);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* b.c  */</span><br><span class="line">int shared = 1;</span><br><span class="line">void swap(int* a, int *b) &#123;</span><br><span class="line">    *a ^= *b ^= *a ^= *b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h3><p>合并多个目标文件中的相同 <code>Section</code>, 分配内存和虚拟地址<br><img src="http://onepiece.nos-eastchina1.126.net/markdown/section-merge.png" alt=":scale 80%"></p>
<h3 id="符号地址确定"><a href="#符号地址确定" class="headerlink" title="符号地址确定"></a>符号地址确定</h3><p>单个目标文件中，每个 <code>Section</code> 的位置已确定，每条指令的 <code>offset</code> 也是固定的，在合并多个目标文件后，<br>将多个相同 <code>Section</code> 合并，调整对应 <code>Section</code> 中的 <code>offset</code> 得到 <code>Section</code> 合并后的 <code>offset</code></p>
<p>另外所有的 <code>VMA</code> 地址未初始化，<code>VMA</code> 的值为 64 linux kernel 的用户态虚拟空间的起始地址 <code>0000000000400000</code><br>加上入口函数（这里先看做是 main 函数）的偏移量（按页对齐）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -w -h a.o</span><br><span class="line">Idx Name            Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  0 .text           0000002e  0000000000000000  0000000000000000  00000040  2**0  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  1 .data           00000000  0000000000000000  0000000000000000  0000006e  2**0  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss            00000000  0000000000000000  0000000000000000  0000006e  2**0  ALLOC</span><br><span class="line">  3 .comment        00000012  0000000000000000  0000000000000000  0000006e  2**0  CONTENTS, READONLY</span><br><span class="line">  4 .note.GNU-stack 00000000  0000000000000000  0000000000000000  00000080  2**0  CONTENTS, READONLY</span><br><span class="line">  5 .eh_frame       00000038  0000000000000000  0000000000000000  00000080  2**3  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">~ objdump -w -h b.o</span><br><span class="line">Idx Name            Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  0 .text           0000004b  0000000000000000  0000000000000000  00000040  2**0  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  1 .data           00000004  0000000000000000  0000000000000000  0000008c  2**2  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss            00000000  0000000000000000  0000000000000000  00000090  2**0  ALLOC</span><br><span class="line">  3 .comment        00000012  0000000000000000  0000000000000000  00000090  2**0  CONTENTS, READONLY</span><br><span class="line">  4 .note.GNU-stack 00000000  0000000000000000  0000000000000000  000000a2  2**0  CONTENTS, READONLY</span><br><span class="line">  5 .eh_frame       00000038  0000000000000000  0000000000000000  000000a8  2**3  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">~ objdump -w -h ab</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn  Flags</span><br><span class="line">  0 .text         00000079  0000000000401000  0000000000401000  00001000  2**0  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  1 .eh_frame     00000058  0000000000402000  0000000000402000  00002000  2**3  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  2 .data         00000004  0000000000404000  0000000000404000  00003000  2**2  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  3 .comment      00000011  0000000000000000  0000000000000000  00003004  2**0  CONTENTS, READONLY</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<h3 id="重定位（指令修正）"><a href="#重定位（指令修正）" class="headerlink" title="重定位（指令修正）"></a>重定位（指令修正）</h3><p>可执行文件中需要重定位的符号的指令地址尚未初始化，先查看需要充定位的符号(UND 类型)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -s a.o</span><br><span class="line"></span><br><span class="line">Symbol table &apos;.symtab&apos; contains 12 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS a.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7</span><br><span class="line">     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     8: 0000000000000000    46 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">     9: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND shared                  // UND 表示未定义的符号，需要重定位</span><br><span class="line">    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND swap                    // 同上</span><br></pre></td></tr></table></figure></p>
<p>查看需要重定位的符号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -r a.o</span><br><span class="line">Relocation section &apos;.rela.text&apos; at offset 0x208 contains 2 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000016  000900000002 R_X86_64_PC32     0000000000000000 shared - 4           // R_X86_64_PC32  相对地址修正</span><br><span class="line">000000000023  000b00000004 R_X86_64_PLT32    0000000000000000 swap - 4             // R_X86_64_PLT32 相对地址修正 + 延迟绑定</span><br><span class="line"></span><br><span class="line">Relocation section &apos;.rela.eh_frame&apos; at offset 0x238 contains 1 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span><br></pre></td></tr></table></figure>
<p>查看 a.o 的汇编代码，看看未重定位前的指令地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -d a.o</span><br><span class="line">0000000000000000 &lt;main&gt;:</span><br><span class="line">   0:   55                      push   %rbp</span><br><span class="line">   1:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">   4:   48 83 ec 10             sub    $0x10,%rsp</span><br><span class="line">   8:   c7 45 fc 64 00 00 00    movl   $0x64,-0x4(%rbp)</span><br><span class="line">   f:   48 8d 45 fc             lea    -0x4(%rbp),%rax</span><br><span class="line">  13:   48 8d 35 00 00 00 00    lea    0x0(%rip),%rsi              # 1a &lt;main+0x1a&gt;  // shared 变量引用， (00 00 00 00) 0x0 未赋值,</span><br><span class="line">  1a:   48 89 c7                mov    %rax,%rdi                                     // 0x1a 是下一条指令偏移，lea 指令压入下一条指令地址</span><br><span class="line">  1d:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  22:   e8 00 00 00 00          callq  27 &lt;main+0x27&gt;                                // callq 调用 swap 函数，0x27 是下一条指令地址</span><br><span class="line">  27:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  2c:   c9                      leaveq</span><br><span class="line">  2d:   c3                      retq</span><br></pre></td></tr></table></figure></p>
<p>查看链接完成后的指令地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~ objdump -d ab</span><br><span class="line">0000000000401000 &lt;main&gt;:</span><br><span class="line">  401000:       55                      push   %rbp</span><br><span class="line">  401001:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  401004:       48 83 ec 10             sub    $0x10,%rsp</span><br><span class="line">  401008:       c7 45 fc 64 00 00 00    movl   $0x64,-0x4(%rbp)</span><br><span class="line">  40100f:       48 8d 45 fc             lea    -0x4(%rbp),%rax</span><br><span class="line">  401013:       48 8d 35 e6 2f 00 00    lea    0x2fe6(%rip),%rsi  # 404000 &lt;shared&gt;  // 0x2fe6 = 0x404000 - 0x40101a</span><br><span class="line">  40101a:       48 89 c7                mov    %rax,%rdi</span><br><span class="line">  40101d:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  401022:       e8 07 00 00 00          callq  40102e &lt;swap&gt;                         // e8 00 00 00 00 -&gt; e8 07 00 00 00;  0x7= 0x40102e - 0x401027</span><br><span class="line">  401027:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  40102c:       c9                      leaveq</span><br><span class="line">  40102d:       c3                      retq</span><br><span class="line"></span><br><span class="line">000000000040102e &lt;swap&gt;:</span><br><span class="line">  40102e:       55                      push   %rbp</span><br><span class="line">  40102f:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  401032:       48 89 7d f8             mov    %rdi,-0x8(%rbp)</span><br><span class="line">  401036:       48 89 75 f0             mov    %rsi,-0x10(%rbp)</span><br></pre></td></tr></table></figure></p>
<h2 id="common块之强弱符号"><a href="#common块之强弱符号" class="headerlink" title="common块之强弱符号"></a>common块之强弱符号</h2><p>强符号:函数和已初始化的全局变量为；弱符号:未初始化的全局变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">extern int ext;</span><br><span class="line"></span><br><span class="line">int weak;                            //  弱符号</span><br><span class="line">int string = 1;                      //  强符号</span><br><span class="line">__attribute__((weak)) weak2 = 2;     //  弱符号</span><br><span class="line"></span><br><span class="line">int main() &#123;                         //  强符号</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多个文件中出现对同一个文件的定义，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/* a. c */  |   /* b.c */</span><br><span class="line">int a;      |   long a;</span><br></pre></td></tr></table></figure>
<ul>
<li>多个强符号冲突，编译失败</li>
<li>强符号和弱符号同时定义，选强符号</li>
<li>多个弱符号，选类型最大的弱符号</li>
<li>定义弱引用，编译时不会报错，运行时报错，可用于链接库函数（比如程序是否支持多线程版本 ‘-lphread’)</li>
<li>使用 ‘-fno-common’ 禁用弱引用</li>
</ul>
<h2 id="全局构造和析构"><a href="#全局构造和析构" class="headerlink" title="全局构造和析构"></a>全局构造和析构</h2><p>main 函数只是编写代码的入口，实际程序运行的入口是 <code>_start</code>，c++ 使用特殊的 <code>Section</code> 控制全局构造和析构</p>
<ul>
<li>.init 构成进程的初始化代码，在 main 函数之前调用</li>
<li>.fini 构成进程的终止代码，在 main 函数退出后执行</li>
</ul>
<h2 id="静态库链接"><a href="#静态库链接" class="headerlink" title="静态库链接"></a>静态库链接</h2><p>静态库是一组目标文件的集合，基本上其中的一个目标文件只包含一个函数，链接时从库中找到具体的函数实现链接成可执行文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ ar -t /usr/lib/libc.a | grep printf</span><br><span class="line">vfprintf.o</span><br><span class="line">vprintf.o</span><br><span class="line">printf_fp.o</span><br><span class="line">reg-printf.o</span><br><span class="line">printf-prs.o</span><br><span class="line">printf_fphex.o</span><br><span class="line">printf_size.o</span><br><span class="line">fprintf.o</span><br></pre></td></tr></table></figure>
<p>如何不使用 <code># include &lt;stdio.h&gt;</code> 实现 hello.c 中对标准库中 <code>printf</code> 函数的引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* hello.c */</span><br><span class="line">int main() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ ar -x /usr/lib/libc.a  -&gt; 得到 printf.o 目标文件</span><br><span class="line">~ ld hello.o printf.o    -&gt; 实际上也会失败，因为 printf 还依赖其他目标文件(vfpintf.o)，但可以按照层次去解决</span><br></pre></td></tr></table></figure>
<p>链接成可执行文件需要的库和目标文件</p>
<ul>
<li>crt1.o</li>
<li>crti.o</li>
<li>crtbeginT.o</li>
<li>libgcc.a</li>
<li>libgcc_eh.a</li>
<li>libc.a</li>
<li>crtend.o</li>
<li>crtn.o</li>
</ul>
<p>crt1.o、crti.o 和 crtn.o 均是 glibc 运行库启动文件的一部分，运行库部分讲解！！</p>
<h2 id="静态链接示例"><a href="#静态链接示例" class="headerlink" title="静态链接示例"></a>静态链接示例</h2><p>静态链接的一个例子，代码和分布</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">        sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -W -S SectionMapping.elf | column</span><br><span class="line">There are <span class="number">31</span> section headers, starting at offset <span class="number">0xbc330</span>:</span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name                Type        Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                     <span class="literal">NULL</span>        <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .note.gnu.build-id  NOTE        <span class="number">0000000000400200</span> <span class="number">000200</span> <span class="number">000024</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .note.ABI-tag       NOTE        <span class="number">0000000000400224</span> <span class="number">000224</span> <span class="number">000020</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .rela.plt           RELA        <span class="number">0000000000400248</span> <span class="number">000248</span> <span class="number">000240</span> <span class="number">18</span>  AI  <span class="number">0</span>  <span class="number">19</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">4</span>] .init               PROGBITS    <span class="number">0000000000401000</span> <span class="number">001000</span> <span class="number">00001b</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .plt                PROGBITS    <span class="number">0000000000401020</span> <span class="number">001020</span> <span class="number">0000</span>c0 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">6</span>] .text               PROGBITS    <span class="number">00000000004010e0</span> <span class="number">0010e0</span> <span class="number">07e1</span>c0 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">7</span>] __libc_freeres_fn   PROGBITS    <span class="number">000000000047f</span>2a0 <span class="number">07f</span>2a0 <span class="number">000</span>aa0 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">8</span>] .fini               PROGBITS    <span class="number">000000000047f</span>d40 <span class="number">07f</span>d40 <span class="number">00000</span>d <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">9</span>] .rodata             PROGBITS    <span class="number">0000000000480000</span> <span class="number">080000</span> <span class="number">01</span>aa8c <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">10</span>] .stapsdt.base       PROGBITS    <span class="number">000000000049</span>aa8c <span class="number">09</span>aa8c <span class="number">000001</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">11</span>] .eh_frame           PROGBITS    <span class="number">000000000049</span>aa90 <span class="number">09</span>aa90 <span class="number">00</span>a1ac <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">12</span>] .gcc_except_table   PROGBITS    <span class="number">00000000004</span>a4c3c <span class="number">0</span>a4c3c <span class="number">0000b</span>1 <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">13</span>] .tdata              PROGBITS    <span class="number">00000000004</span>a6140 <span class="number">0</span>a5140 <span class="number">000020</span> <span class="number">00</span> WAT  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">14</span>] .tbss               NOBITS      <span class="number">00000000004</span>a6160 <span class="number">0</span>a5160 <span class="number">000040</span> <span class="number">00</span> WAT  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">15</span>] .init_array         INIT_ARRAY  <span class="number">00000000004</span>a6160 <span class="number">0</span>a5160 <span class="number">000010</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">16</span>] .fini_array         FINI_ARRAY  <span class="number">00000000004</span>a6170 <span class="number">0</span>a5170 <span class="number">000010</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">17</span>] .data.rel.ro        PROGBITS    <span class="number">00000000004</span>a6180 <span class="number">0</span>a5180 <span class="number">002</span>d74 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">18</span>] .got                PROGBITS    <span class="number">00000000004</span>a8ef8 <span class="number">0</span>a7ef8 <span class="number">0000f</span>0 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">19</span>] .got.plt            PROGBITS    <span class="number">00000000004</span>a9000 <span class="number">0</span>a8000 <span class="number">0000</span>d8 <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">20</span>] .data               PROGBITS    <span class="number">00000000004</span>a90e0 <span class="number">0</span>a80e0 <span class="number">001</span>a50 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">21</span>] __libc_subfreeres   PROGBITS    <span class="number">00000000004</span>aab30 <span class="number">0</span>a9b30 <span class="number">000048</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">22</span>] __libc_IO_vtables   PROGBITS    <span class="number">00000000004</span>aab80 <span class="number">0</span>a9b80 <span class="number">0006</span>a8 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">23</span>] __libc_atexit       PROGBITS    <span class="number">00000000004</span>ab228 <span class="number">0</span>aa228 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">24</span>] .bss                NOBITS      <span class="number">00000000004</span>ab240 <span class="number">0</span>aa230 <span class="number">001758</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">25</span>] __libc_freeres_ptrs NOBITS      <span class="number">00000000004</span>ac998 <span class="number">0</span>aa230 <span class="number">000028</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">26</span>] .comment            PROGBITS    <span class="number">0000000000000000</span> <span class="number">0</span>aa230 <span class="number">000011</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">27</span>] .note.stapsdt       NOTE        <span class="number">0000000000000000</span> <span class="number">0</span>aa244 <span class="number">000048</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">28</span>] .symtab             SYMTAB      <span class="number">0000000000000000</span> <span class="number">0</span>aa290 <span class="number">00b</span>0a0 <span class="number">18</span>     <span class="number">29</span> <span class="number">752</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">29</span>] .strtab             STRTAB      <span class="number">0000000000000000</span> <span class="number">0b</span>5330 <span class="number">006</span>eb5 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">30</span>] .shstrtab           STRTAB      <span class="number">0000000000000000</span> <span class="number">0b</span>c1e5 <span class="number">000144</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<h2 id="静态链接内存映射"><a href="#静态链接内存映射" class="headerlink" title="静态链接内存映射"></a>静态链接内存映射</h2><p>查看编译好的 elf 文件的 <code>Segment</code>(将 Section 合并得到 <code>Segment</code>) 信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">~ readelf -W -l SectionMapping.elf</span><br><span class="line"></span><br><span class="line">Elf file <span class="keyword">type</span> is EXEC (Executable file)</span><br><span class="line">Entry point <span class="number">0x401ac0</span></span><br><span class="line">There are <span class="number">8</span> program headers, starting at offset <span class="number">64</span></span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  LOAD           <span class="number">0x000000</span> <span class="number">0x0000000000400000</span> <span class="number">0x0000000000400000</span> <span class="number">0x000488</span> <span class="number">0x000488</span> R   <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x001000</span> <span class="number">0x0000000000401000</span> <span class="number">0x0000000000401000</span> <span class="number">0x07ed4d</span> <span class="number">0x07ed4d</span> R E <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x080000</span> <span class="number">0x0000000000480000</span> <span class="number">0x0000000000480000</span> <span class="number">0x024ced</span> <span class="number">0x024ced</span> R   <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x0a5140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x0050f</span>0 <span class="number">0x006880</span> RW  <span class="number">0x1000</span></span><br><span class="line">  NOTE           <span class="number">0x000200</span> <span class="number">0x0000000000400200</span> <span class="number">0x0000000000400200</span> <span class="number">0x000044</span> <span class="number">0x000044</span> R   <span class="number">0x4</span></span><br><span class="line">  TLS            <span class="number">0x0a5140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x000020</span> <span class="number">0x000060</span> R   <span class="number">0x8</span></span><br><span class="line">  GNU_STACK      <span class="number">0x000000</span> <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span> <span class="number">0x000000</span> <span class="number">0x000000</span> RW  <span class="number">0x10</span></span><br><span class="line">  GNU_RELRO      <span class="number">0x0a5140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x00000000004a6140</span> <span class="number">0x002ec0</span> <span class="number">0x002ec0</span> R   <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span>     .note.gnu.build-id .note.ABI-tag .rela.plt</span><br><span class="line">   <span class="number">01</span>     .init .plt .text __libc_freeres_fn .fini</span><br><span class="line">   <span class="number">02</span>     .rodata .stapsdt.base .eh_frame .gcc_except_table</span><br><span class="line">   <span class="number">03</span>     .tdata .init_array .fini_array .data.rel.ro .got .got.plt .data __libc_subfreeres __libc_IO_vtables __libc_atexit .bss __libc_freeres_ptrs</span><br><span class="line">   <span class="number">04</span>     .note.gnu.build-id .note.ABI-tag</span><br><span class="line">   <span class="number">05</span>     .tdata .tbss</span><br><span class="line">   <span class="number">06</span></span><br><span class="line">   <span class="number">07</span>     .tdata .init_array .fini_array .data.rel.ro .got</span><br></pre></td></tr></table></figure>
<p>程序运行起来后的实际内存映射情况</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ ./SectionMapping.elf &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">106421</span></span><br><span class="line">~ cat /proc/<span class="number">106421</span>/maps</span><br><span class="line"><span class="number">00400000</span><span class="number">-00401000</span> r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">00401000</span><span class="number">-00480000</span> r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">00480000</span><span class="number">-004</span>a5000 r--p <span class="number">00080000</span> <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">004</span>a6000<span class="number">-004</span>ac000 rw-p <span class="number">000</span>a5000 <span class="number">08</span>:<span class="number">02</span> <span class="number">9571400</span>                            /home/vagrant/compile-link-load/SectionMapping.elf</span><br><span class="line"><span class="number">004</span>ac000<span class="number">-004</span>ad000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="number">01539000</span><span class="number">-0155</span>c000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [heap]</span><br><span class="line"><span class="number">7f</span>fffa319000<span class="number">-7f</span>fffa33a000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">7f</span>fffa367000<span class="number">-7f</span>fffa36a000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vvar]</span><br><span class="line"><span class="number">7f</span>fffa36a000<span class="number">-7f</span>fffa36b000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h1><h2 id="什么是动态链接"><a href="#什么是动态链接" class="headerlink" title="什么是动态链接"></a>什么是动态链接</h2><p>为什么需要动态链接？</p>
<ul>
<li>静态链接浪费内存空间，对任何公共库函数每个函数都要链接进可执行文件</li>
<li>不利于程序的开发和发布，任务静态库更新后，可执行文件需要重新编译</li>
</ul>
<p>什么是动态链接？</p>
<ul>
<li>程序的模块分隔开，形成独立的文件，不再将他们链接在一起；等程序运行时链接需要的模块</li>
<li>program1 和 program2 都依赖 lib.so</li>
<li>program1 运行时发现依赖 lib.so，操作系统将 lib.so 加载至内存，开始链接过程（符号解析、地址定位等</li>
<li>运行 program2，加载 program2 是发现其依赖 lib.so，而此时内存中已经有 lib.so 的 副本，则不需要重新加载，只需要链接 program2 和 lib.so</li>
</ul>
<p>动态链接优势？</p>
<ul>
<li>节省内存</li>
<li>减少物理页面的换入和换出</li>
<li>增加 cpu 缓存命中率</li>
<li>动态的加载各种程序模块（插件开发）</li>
</ul>
<p>缺点？</p>
<ul>
<li>动态链接的版本不一致，api 接口变动等，导致程序不能运行 (DLL Hell)</li>
<li>程序加载时需要代码和数据的重定位（GOT 定位），加上间接寻址，导致程序的运行速度变慢（启动速度）</li>
</ul>
<h2 id="地址无关代码"><a href="#地址无关代码" class="headerlink" title="地址无关代码"></a>地址无关代码</h2><p>编译时指定 <code>-fPIC</code> 可让动态库编译成地址无关（<code>-fpic</code> 和 <code>-fPIC</code> 功能一致，但包小，会出现兼容问题，一般使用 <code>-fPIC</code>)；<br>从静态链接的链接过程中，我们也可以按照静态链接的方式链接动态库，对动态链接中的绝对地址做基址重置；但做基址重置时基址是调用该库的程序的基址，<br>比如 <code>program1</code> 调用库的需要基址重置修改库中的指令地址，而 <code>program2</code> 调用库也需要修改指令地址；<br>这样 <code>program1</code> 和 <code>program2</code> 需要自己维护各自的库指令和数据，失去了动态链接的意义。</p>
<p>地址无关：把指令中需要被修改的部分分离出来，跟数据块放在一起，指令部分可以保持不变，数据部分可以再进程中拥有自己的副本。</p>
<p>共享库中地址引用的方式：</p>
<ul>
<li>模块内部调用和跳转：调用函数和调用者在同一个模块，位置相对固定，使用相对地址调用或寄存器相对调用</li>
<li>模块内部数据访问：.text 和 .data 的相对位置也是固定的，也可以使用相对地址调用</li>
<li>模块间数据访问和模块间调用和跳转</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static int a;</span><br><span class="line">extern int b;       // b 在其他动态模块中</span><br><span class="line">extern void ext();  // ext 函数在其他模块中</span><br><span class="line"></span><br><span class="line">void bar() &#123;</span><br><span class="line">    a = 1;</span><br><span class="line">    b = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void foo() &#123;</span><br><span class="line">    bar();</span><br><span class="line">    ext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中 b 和 ext 的目标地址需要等到装载时才能决定，引入 GOT 表（ GLOBAL Offset Table)，GOT 表存储在 .data 字段，那么 GOT 表和代码段的相对位置可以固定<br>GOT 表存存储需要访问的外部变量的地址，则通过一次间接寻址可以获取 b 的实际地址；但编译时是 GOT 表中的对应项是 0，在程序加载时确定外部模块的地址后才能由<strong>动态链接器</strong>填入具体值</p>
<h2 id="GOT-实现原理"><a href="#GOT-实现原理" class="headerlink" title="GOT 实现原理"></a>GOT 实现原理</h2><p><img src="http://onepiece.nos-eastchina1.126.net/markdown/got.png" alt=":scale 80%"></p>
<hr>
<h2 id="延迟绑定-PLT"><a href="#延迟绑定-PLT" class="headerlink" title="延迟绑定 PLT"></a>延迟绑定 PLT</h2><p>动态链接相对灵活，却牺牲一部分性能</p>
<ul>
<li>全局和静态数据的间接寻址</li>
<li>模块间调用的GOT重定位; 动态链接是运行时完成，寻找并装共享对象，进行符号地址重定位</li>
</ul>
<p>在程序执行前，动态链接会耗费时间解决模块之间的函数引用符号的查找和重定位，然后很多函数可能很少用到，如错误处理函数。 ELF 采用延迟绑定（lazing binding)<br>, <strong>当函数第一次被用到是才进行绑定</strong>，如果没用用到就不绑定。ELF 使用 PLT （procedure linkage table)来实现；在 GOT 实现中，外部变量的引用的间接寻址的值由链接器加载时填入，使用 PLT 可以延迟这个过程。</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/got-plt.png" alt=":scale 100%"></p>
<h2 id="动态链接结构"><a href="#动态链接结构" class="headerlink" title="动态链接结构"></a>动态链接结构</h2><ul>
<li>.interp 共享库使用的解释器，一般为 /lib/ld-linux.so</li>
<li>.dynampic 保存动态链接需要的用到的信息；动态链接符号地址，动态链接字符串地址，重定位表入口等</li>
<li>.dynsym 保存于动态链接相关的符号</li>
<li>.symtab 保存所有的符号</li>
<li>.rela.dyn 对数据引用修正，修正位置位于.got</li>
<li>.rela.plt 对函数引用修正，修正位置位于 .got.plt</li>
</ul>
<h2 id="动态链接过程"><a href="#动态链接过程" class="headerlink" title="动态链接过程"></a>动态链接过程</h2><ul>
<li>ld-linux.so 自举</li>
<li>装载共享对象</li>
<li>重定位和初始化</li>
</ul>
<h2 id="显示运行时链接"><a href="#显示运行时链接" class="headerlink" title="显示运行时链接"></a>显示运行时链接</h2><ul>
<li>dlopen</li>
<li>dlsym</li>
<li>dlerror</li>
<li>dlclose</li>
</ul>
<h2 id="共享库的组织"><a href="#共享库的组织" class="headerlink" title="共享库的组织"></a>共享库的组织</h2><p><strong>命名规范</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libname.so.x.y.z</span><br></pre></td></tr></table></figure></p>
<p>lib 是前缀，中间是库名字</p>
<ul>
<li>x 主版本号 重大升级，不同主版本号不兼容</li>
<li>y 次版本号，增量升级，增加新接口，保持原来符号不变</li>
<li>z 发布版本号，错误修正，性能改进，不添加任何新接口</li>
</ul>
<p><strong>so-name 机制</strong></p>
<p>每个共享库都有一个 so-name, 去掉次版本号和发布版本号，共享库 /lib/libfoo.so.2.6.1 对应的 so-name 为 /lib/libfoo.so.2 的软链接</p>
<p><strong>环境变量</strong></p>
<ul>
<li>LD_LIBRARY_PATH 设置搜索路径，调试动态库</li>
<li>LD_PRELOAD 预先加载覆盖后加载的共享库，用于测试</li>
<li>LD_DEBUG 打印调试信息，打印装载过程</li>
</ul>
<hr>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><ul>
<li>segfault dmseg</li>
<li>错误线索</li>
<li>定位步骤</li>
</ul>
<h2 id="segfault-dmesg"><a href="#segfault-dmesg" class="headerlink" title="segfault dmesg"></a>segfault dmesg</h2><p><a href="https://utcc.utoronto.ca/~cks/space/blog/linux/KernelSegfaultMessageMeaning" target="_blank" rel="noopener">戳我!</a><br><code>segfault</code> 产生时会在系统的日志中记录错误信息，可以用 dmesg 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ dmesg | grep testp</span><br><span class="line">testp[19288]: segfault at 0 ip 0000000000401271 sp 00007fff2ce4d210 error 4 in testp[400000+98000]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>testp[19288]</code> 是发错段错误的 <code>PID</code></li>
<li><code>segfault at 0</code> 表示程序访问地址 <code>0</code> 是发生了段错误；地址 <code>0</code> 可能访问了空指针。</li>
<li><code>ip 0000000000401271</code> 是指令之指针（<code>instruction pointer</code>），在 64-bit x86 下对应的寄存器为 <code>%rip</code></li>
<li><code>sp 00007fff2ce4d210</code> 是栈指针（stack pointer）, 在 64-bit x86 下对应的寄存器为 <code>%rsp</code></li>
<li><code>error 4</code> 是 16 进制的<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/traps.h#n148" target="_blank" rel="noopener">错误码</a>； 一般情况下至少为 4 表示是用户态的错误；4 表示读一个未映射的内存（unmapped area)，6（4+2）表示写一个未映射的内存</li>
<li><code>in testp[400000+98000]</code> 段错误的程序是 <code>testp</code>, 其 <code>ip</code> 所在的虚拟地址范围为 <code>0x400000 ~ 0x400000+0x98000</code>, 0x98000 表示是该程序映射的大小</li>
</ul>
<h2 id="错误线索"><a href="#错误线索" class="headerlink" title="错误线索"></a>错误线索</h2><ul>
<li><p>curl</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vagrant@archlinux:~/nos-openresty  master ✗ curl -v 'http://127.0.0.1:1989?ip=121.193.184.2'</span><br><span class="line">* Rebuilt URL to: http:<span class="comment">//127.0.0.1:1989/?ip=121.193.184.2</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">1989</span> (#<span class="number">0</span>)</span><br><span class="line">&gt; GET /?ip=<span class="number">121.193</span><span class="number">.184</span><span class="number">.2</span> HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1989</span></span><br><span class="line">&gt; User-Agent: curl/<span class="number">7.59</span><span class="number">.0</span></span><br><span class="line">&gt; Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Empty reply from server</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br><span class="line"><span class="comment">curl: (52) Empty reply from server</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>error log</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">11</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">57</span>:<span class="number">43</span> [notice] <span class="number">14393</span>#<span class="number">14393</span>: signal <span class="number">17</span> (SIGCHLD) received from <span class="number">14394</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">11</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">57</span>:<span class="number">43</span> [alert] <span class="number">14393</span>#<span class="number">14393</span>: worker process <span class="number">14394</span> exited on signal <span class="number">11</span> (core dumped)</span><br><span class="line"><span class="number">2019</span>/<span class="number">11</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">57</span>:<span class="number">43</span> [notice] <span class="number">14393</span>#<span class="number">14393</span>: start worker process <span class="number">14566</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>demsg</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">37568.563121</span>] nginx[<span class="number">14394</span>]: segfault at a ip <span class="number">00007f</span>10ef0973fd sp <span class="number">00007f</span>fc1688f480 error <span class="number">6</span> in lipip.so[<span class="number">7f</span>10ef096000+<span class="number">2000</span>]</span><br></pre></td></tr></table></figure>
<p>  这里的 <code>lipip.so[7f10ef096000+2000]</code> 已经表明了是 lipip.so 中的异常，如果没有标识出是 <code>lipip</code> 库的异常，可以根据 maps 看是共享库还是程序本身的异常。<code>7f10ef096000+2000</code> 中<br>  <code>7f10ef096000</code> 是基址偏移量， <code>+2000</code> 标识这个 map 对应的大小。</p>
</li>
</ul>
<h2 id="定位步骤"><a href="#定位步骤" class="headerlink" title="定位步骤"></a>定位步骤</h2><ul>
<li><p>先看下 lipip.so 有没有 dwarf</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vagrant@archlinux:~/reading/lipip  develop ✗ readelf -W -S lipip.so</span><br><span class="line">There are <span class="number">35</span> section headers, starting at offset <span class="number">0x67d0</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .note.gnu.build-id NOTE            <span class="number">00000000000001</span>c8 <span class="number">0001</span>c8 <span class="number">000024</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .gnu.hash         GNU_HASH        <span class="number">00000000000001f</span>0 <span class="number">0001f</span>0 <span class="number">000050</span> <span class="number">00</span>   A  <span class="number">3</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line"></span><br><span class="line">                             ......</span><br><span class="line"></span><br><span class="line">  [<span class="number">11</span>] .text             PROGBITS        <span class="number">00000000000010e0</span> <span class="number">0010e0</span> <span class="number">0008b</span>2 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line"></span><br><span class="line">                             ......</span><br><span class="line"></span><br><span class="line">  [<span class="number">20</span>] .got              PROGBITS        <span class="number">0000000000201f</span>e0 <span class="number">001f</span>e0 <span class="number">000020</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">21</span>] .got.plt          PROGBITS        <span class="number">0000000000202000</span> <span class="number">002000</span> <span class="number">000138</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">22</span>] .data             PROGBITS        <span class="number">0000000000202140</span> <span class="number">002140</span> <span class="number">000060</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">23</span>] .bss              NOBITS          <span class="number">00000000002021</span>a0 <span class="number">0021</span>a0 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">24</span>] .comment          PROGBITS        <span class="number">0000000000000000</span> <span class="number">0021</span>a0 <span class="number">00001</span>a <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">25</span>] .debug_aranges    PROGBITS        <span class="number">0000000000000000</span> <span class="number">0021b</span>a <span class="number">000090</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">26</span>] .debug_info       PROGBITS        <span class="number">0000000000000000</span> <span class="number">00224</span>a <span class="number">001830</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">27</span>] .debug_abbrev     PROGBITS        <span class="number">0000000000000000</span> <span class="number">003</span>a7a <span class="number">000503</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">28</span>] .debug_line       PROGBITS        <span class="number">0000000000000000</span> <span class="number">003f</span>7d <span class="number">00046f</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">29</span>] .debug_str        PROGBITS        <span class="number">0000000000000000</span> <span class="number">0043</span>ec <span class="number">0005</span>a6 <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">30</span>] .debug_loc        PROGBITS        <span class="number">0000000000000000</span> <span class="number">004992</span> <span class="number">000</span>ec9 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">31</span>] .debug_ranges     PROGBITS        <span class="number">0000000000000000</span> <span class="number">00585b</span> <span class="number">000060</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">32</span>] .symtab           SYMTAB          <span class="number">0000000000000000</span> <span class="number">0058</span>c0 <span class="number">0009</span>a8 <span class="number">18</span>     <span class="number">33</span>  <span class="number">57</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">33</span>] .strtab           STRTAB          <span class="number">0000000000000000</span> <span class="number">006268</span> <span class="number">00040</span>e <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">34</span>] .shstrtab         STRTAB          <span class="number">0000000000000000</span> <span class="number">006676</span> <span class="number">000153</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>  如果没有 <code>.debug</code> 开头的 section，说明没有 dwarf 符号，需要到编译机 <code>-g</code> 重新编译。</p>
</li>
<li><p>看程序段的地址分配</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[11] .text             PROGBITS        00000000000010e0 0010e0 0008b2 00  AX  0   0 16</span><br></pre></td></tr></table></figure>
<p>  范围为 <code>0x00000000000010e0 ~ 0000000000001992(0x00000000000010e0+0x0008b2)</code></p>
</li>
<li><p>查看 segfault 错误信息</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">segfault at a ip 00007f10ef0973fd sp 00007ffc1688f480 error 6 in lipip.so[7f10ef096000+2000]</span><br></pre></td></tr></table></figure>
<p>  用 ip 值减去基址偏移:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007f10ef0973fd - 0x7f10ef096000 = 0x13fd</span><br></pre></td></tr></table></figure>
</li>
<li><p>用 addr2line 工具定位错误行号</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant@archlinux:~/reading/lipip  develop ✗ addr2line -e lipip.so 0x13fd</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看代码行号</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 96     ...</span><br><span class="line"> 97     if (s &lt;= e) &#123;</span><br><span class="line"> 98         lua_pushstring(L, s);</span><br><span class="line"> 99         lua_rawseti(L, -2, i);</span><br><span class="line">100     &#125;</span><br><span class="line">101</span><br><span class="line">102     int *p = 10;</span><br><span class="line">103     *p = 0;                         // 修改栈上值</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="运行库"><a href="#运行库" class="headerlink" title="运行库"></a>运行库</h1><h2 id="启动函数"><a href="#启动函数" class="headerlink" title="启动函数"></a>启动函数</h2><p>main 函数并非程序的起点: <code>_start -&gt; _libc_start_main (.init -&gt; rtld_fini -&gt; .fini)-&gt; main -&gt; exit</code></p>
<ul>
<li>crt1.o 是程序的真正入口函数 _start，由它调用 <code>_libc_start_main</code>，包含基本的启动、退出代码。开始叫 crt.0，为强调是链接输入第一个文件更名为 crt0.o， 后来为了兼容 .init 和 .fint 又升级为 crt1.o</li>
<li>由于c++ 出现和 elf 改进，必须在 main 函数之前全局/静态对象的构造，glibc 库在每个目标文件中引入了 .init 和 .fint 段； crti.o 和 crtn.o 帮助 .init 和 .fint 完成构造和清理相关工作</li>
<li>crti.o 和 crtn.o 提供了 .init 和 .finit 的机制， 实际完成构造和析构的是 crtbeginT.o 和 crtend.o</li>
</ul>
<h2 id="运行库-1"><a href="#运行库-1" class="headerlink" title="运行库"></a>运行库</h2><p>运行库（runtime library), C 运行库 CRT</p>
<ul>
<li>启动与退出</li>
<li>标准函数（标准输入、输出；文件；字符；字符串..)</li>
<li>I/O</li>
<li>堆 / 特殊实现 / 调试</li>
</ul>
<h2 id="标准函数变长实现"><a href="#标准函数变长实现" class="headerlink" title="标准函数变长实现"></a>标准函数变长实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define va_list char*</span><br><span class="line">#define va_start(ap,arg) (ap=(va_list)&amp;arg+sizeof(arg))</span><br><span class="line">#define va_arg(ap, t) (*(t*)(ap+=sizeof(t))-sizeof(t))</span><br><span class="line">#define va_end(ap) (ap=(va_list)0)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdarg.h&gt;</span><br><span class="line"></span><br><span class="line">void</span><br><span class="line">foo(char *fmt, ...)</span><br><span class="line">&#123;</span><br><span class="line">    va_list ap;</span><br><span class="line">    int d;</span><br><span class="line">    char c, *s;</span><br><span class="line"></span><br><span class="line">    va_start(ap, fmt);</span><br><span class="line">    while (*fmt)</span><br><span class="line">        switch (*fmt++) &#123;</span><br><span class="line">        case &apos;s&apos;:              /* string */</span><br><span class="line">            s = va_arg(ap, char *);</span><br><span class="line">            printf(&quot;string %s\n&quot;, s);</span><br><span class="line">            break;</span><br><span class="line">        case &apos;d&apos;:              /* int */</span><br><span class="line">            d = va_arg(ap, int);</span><br><span class="line">            printf(&quot;int %d\n&quot;, d);</span><br><span class="line">            break;</span><br><span class="line">        case &apos;c&apos;:              /* char */</span><br><span class="line">            c = (char) va_arg(ap, int);</span><br><span class="line">            printf(&quot;char %c\n&quot;, c);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    va_end(ap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么只有 cdcel 可以实现变长参数，而 stdcall 不能实现变长参数？</p>
<h2 id="CRT-与多线程"><a href="#CRT-与多线程" class="headerlink" title="CRT 与多线程"></a>CRT 与多线程</h2><ul>
<li><p>多线程版本运行库中，线程不安全函数会自动加锁，包括 malloc, printf 等</p>
</li>
<li><p>errno <code># define errno (*__errno_location())</code> 不同的 <code>__errno_location</code> 返回地址不同</p>
</li>
<li><p>线程特有的只是栈（出入栈频繁，不可控）和寄存器（数量少），使用 <code>Thread Local Storage</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__thread int number`</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="系统调用与API"><a href="#系统调用与API" class="headerlink" title="系统调用与API"></a>系统调用与API</h1><p>什么是系统调用？<br>程序运行时，其本身是没有多少æ利去访问系统资源(文件、网络、io 等)的，因系统有限的资源可能被多个不同的程序同时访问，需要系统级的保护和协调。</p>
<p>linux 系统调用<br>使用通用寄存器传递参数，EAX 寄存器传递系统调用号(例如0x80)，EAX=1(exit); EAX=2(fork); EAX=3(IO read); EAX=4(IO write)；<br>系统调用可以绕过 glibc 直接使用（性能考虑)</p>
<p>linux 为了系统的稳定性和安全性分为两种特权级别：用户态和内核态，系统调用运行在内核态，而要使用系统调用时必须有用户态切换到内核态，切换的过程是通过中断实现。</p>
<h2 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h2><p>中断是一个硬件或软件发出的请求，要求 cpu 暂停当前的工作去处理其他事情;<br>中断有两个属性，中断号和中断处理程序，而中断号是有限的，所以 linux 采用中断号和系统调用号组合来实现不通的系统调用</p>
<p><img src="http://onepiece.nos-eastchina1.126.net/markdown/interrupt1.png" alt=":scale 90%"></p>
<ul>
<li>触发中断</li>
<li>切换堆栈（用户态和内核态使用不同的栈，切换至当前栈(ESP 寄存器的值）至内核态的栈)</li>
<li>中断处理程序</li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/31/OpenResty-Best-Practice/" rel="next" title="OpenResty Best Practice">
                <i class="fa fa-chevron-left"></i> OpenResty Best Practice
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="anyfeel" />
            
              <p class="site-author-name" itemprop="name">anyfeel</p>
              <p class="site-description motion-element" itemprop="description">我就是我，是颜色不一样的烟花</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#引子"><span class="nav-number">1.</span> <span class="nav-text">引子</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#过度优化-volatile"><span class="nav-number">1.1.</span> <span class="nav-text">过度优化 - volatile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过度优化-barrier"><span class="nav-number">1.2.</span> <span class="nav-text">过度优化 - barrier</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内存与装载"><span class="nav-number">2.</span> <span class="nav-text">内存与装载</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#进程堆管理"><span class="nav-number">2.1.</span> <span class="nav-text">进程堆管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用惯例"><span class="nav-number">2.2.</span> <span class="nav-text">调用惯例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译"><span class="nav-number">3.</span> <span class="nav-text">编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#预编译"><span class="nav-number">3.1.</span> <span class="nav-text">预编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译-1"><span class="nav-number">3.2.</span> <span class="nav-text">编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#词法分析"><span class="nav-number">3.2.1.</span> <span class="nav-text">词法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#语法分析"><span class="nav-number">3.2.2.</span> <span class="nav-text">语法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#语义分析"><span class="nav-number">3.2.3.</span> <span class="nav-text">语义分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#汇编"><span class="nav-number">3.3.</span> <span class="nav-text">汇编</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#链接"><span class="nav-number">3.4.</span> <span class="nav-text">链接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#目标文件"><span class="nav-number">4.</span> <span class="nav-text">目标文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#目标文件类型"><span class="nav-number">4.1.</span> <span class="nav-text">目标文件类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标内容"><span class="nav-number">4.2.</span> <span class="nav-text">目标内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标文件段分布"><span class="nav-number">4.3.</span> <span class="nav-text">目标文件段分布</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#静态链接"><span class="nav-number">5.</span> <span class="nav-text">静态链接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#静态链接过程"><span class="nav-number">5.1.</span> <span class="nav-text">静态链接过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#段合并"><span class="nav-number">5.1.1.</span> <span class="nav-text">段合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#符号地址确定"><span class="nav-number">5.1.2.</span> <span class="nav-text">符号地址确定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定位（指令修正）"><span class="nav-number">5.1.3.</span> <span class="nav-text">重定位（指令修正）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#common块之强弱符号"><span class="nav-number">5.2.</span> <span class="nav-text">common块之强弱符号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#全局构造和析构"><span class="nav-number">5.3.</span> <span class="nav-text">全局构造和析构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态库链接"><span class="nav-number">5.4.</span> <span class="nav-text">静态库链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态链接示例"><span class="nav-number">5.5.</span> <span class="nav-text">静态链接示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态链接内存映射"><span class="nav-number">5.6.</span> <span class="nav-text">静态链接内存映射</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#动态链接"><span class="nav-number">6.</span> <span class="nav-text">动态链接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是动态链接"><span class="nav-number">6.1.</span> <span class="nav-text">什么是动态链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#地址无关代码"><span class="nav-number">6.2.</span> <span class="nav-text">地址无关代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GOT-实现原理"><span class="nav-number">6.3.</span> <span class="nav-text">GOT 实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#延迟绑定-PLT"><span class="nav-number">6.4.</span> <span class="nav-text">延迟绑定 PLT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态链接结构"><span class="nav-number">6.5.</span> <span class="nav-text">动态链接结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态链接过程"><span class="nav-number">6.6.</span> <span class="nav-text">动态链接过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示运行时链接"><span class="nav-number">6.7.</span> <span class="nav-text">显示运行时链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#共享库的组织"><span class="nav-number">6.8.</span> <span class="nav-text">共享库的组织</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实战"><span class="nav-number">7.</span> <span class="nav-text">实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#segfault-dmesg"><span class="nav-number">7.1.</span> <span class="nav-text">segfault dmesg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误线索"><span class="nav-number">7.2.</span> <span class="nav-text">错误线索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定位步骤"><span class="nav-number">7.3.</span> <span class="nav-text">定位步骤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#运行库"><span class="nav-number">8.</span> <span class="nav-text">运行库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#启动函数"><span class="nav-number">8.1.</span> <span class="nav-text">启动函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行库-1"><span class="nav-number">8.2.</span> <span class="nav-text">运行库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#标准函数变长实现"><span class="nav-number">8.3.</span> <span class="nav-text">标准函数变长实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRT-与多线程"><span class="nav-number">8.4.</span> <span class="nav-text">CRT 与多线程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统调用与API"><span class="nav-number">9.</span> <span class="nav-text">系统调用与API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#中断"><span class="nav-number">9.1.</span> <span class="nav-text">中断</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">anyfeel</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Pisces</a> v6.4.2</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  

  
    <script id="dsq-count-scr" src="https://anyfeel-cn.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2019/11/29/link-load-library/';
        this.page.identifier = '2019/11/29/link-load-library/';
        this.page.title = 'link-load-library';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://anyfeel-cn.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.time + 1);
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "inBlnKMv1VjHkaivHEP16QIR-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "inBlnKMv1VjHkaivHEP16QIR-gzGzoHsz",
                'X-LC-Key': "SNgeOmE0kLNPw2H5Iv2BitUs",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  
  

  

  

  

  

  

</body>
</html>
